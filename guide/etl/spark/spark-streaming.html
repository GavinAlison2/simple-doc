<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/simple-doc/images/favicon.ico"><title>Streaming | Blog</title><meta name="description" content="个人博客">
    <link rel="preload" href="/simple-doc/assets/style-B3-VMakp.css" as="style"><link rel="stylesheet" href="/simple-doc/assets/style-B3-VMakp.css">
    <link rel="modulepreload" href="/simple-doc/assets/app-DzmgiGLk.js"><link rel="modulepreload" href="/simple-doc/assets/spark-streaming.html-C79K96h6.js"><link rel="modulepreload" href="/simple-doc/assets/20250419113150-DJ5Mf0GY.js">
    <link rel="prefetch" href="/simple-doc/assets/index.html-CoRS7up-.js" as="script"><link rel="prefetch" href="/simple-doc/assets/bak-README.html-By5_RZXG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/get-started.html-CX2qJGDP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/etl-resume.html-xtgXy6z6.js" as="script"><link rel="prefetch" href="/simple-doc/assets/java-resume.html-MbjdglIm.js" as="script"><link rel="prefetch" href="/simple-doc/assets/web3-resume.html-CikP1eyy.js" as="script"><link rel="prefetch" href="/simple-doc/assets/小程序.html-CDlbppON.js" as="script"><link rel="prefetch" href="/simple-doc/assets/时间规划.html-BzeHPhhR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/自媒体.html-Cd51wR84.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-JVM什么样的对象直接进入老年代.html-BgGtMJfm.js" as="script"><link rel="prefetch" href="/simple-doc/assets/2-JVM双亲委派机制.html-EJgrsmjs.js" as="script"><link rel="prefetch" href="/simple-doc/assets/3-JVM内存分布.html-BNCPBUEF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/4-JVM内存分配.html-fuLBw3Qt.js" as="script"><link rel="prefetch" href="/simple-doc/assets/5-gc.html-BI2-qePY.js" as="script"><link rel="prefetch" href="/simple-doc/assets/6-解析Class文件.html-B0pdOeBg.js" as="script"><link rel="prefetch" href="/simple-doc/assets/7-cmsGC的工作原理和致命缺陷.html-CKme9mJJ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/8-g1.html-CFg_ulNq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-a7bADKk7.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-批量导入死锁问题.html-CFzLBwM-.js" as="script"><link rel="prefetch" href="/simple-doc/assets/如何排查问题cpu100_.html-BKkcpYrF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/react-readme.html-BExZaYZc.js" as="script"><link rel="prefetch" href="/simple-doc/assets/react-simple.html-DPBznu7L.js" as="script"><link rel="prefetch" href="/simple-doc/assets/react1-do.html-jiGx_V6Y.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BDXEyqA_.js" as="script"><link rel="prefetch" href="/simple-doc/assets/min-project.html-CuU9qQvE.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html--77HvGhr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/ts-decorator.html-DkpslRnk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/ts-quick-start.html-Cbp6FnOa.js" as="script"><link rel="prefetch" href="/simple-doc/assets/ts-readme-viavideo.html-Y8GJV3vk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/typescript-readme.html-DyNtQ7Ji.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1.html-Bfd5rOdV.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-数据仓库工具箱-笔记.html-C8pQnBFr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/2-数据产品经理的工作笔记.html-BM9xLdrs.js" as="script"><link rel="prefetch" href="/simple-doc/assets/3-数据产品经理实战笔记.html-C_1_g8pR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BOqGVW8u.js" as="script"><link rel="prefetch" href="/simple-doc/assets/产品经理岗位分析.html-Dbf3e_fP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/后端开发.html-BlQJsHwK.js" as="script"><link rel="prefetch" href="/simple-doc/assets/001-let-var-const.html-CyrPBvrI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/002-let.html-BRY54MvC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/003-constructor.html-Bf56WLlT.js" as="script"><link rel="prefetch" href="/simple-doc/assets/004-rest-arg.html-C93Fbzea.js" as="script"><link rel="prefetch" href="/simple-doc/assets/005-extend-expression.html-CidDhcRf.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-关键词.html-Zd6Hztyi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/array.html-D_StCr91.js" as="script"><link rel="prefetch" href="/simple-doc/assets/async-await.html-FZal8qrj.js" as="script"><link rel="prefetch" href="/simple-doc/assets/closure.html-CnkoR_MC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/fun.html-D1YSgeV5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/promise.html-JIYwOKe8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-Bxa3QD7u.js" as="script"><link rel="prefetch" href="/simple-doc/assets/regex.html-Cq95gnhA.js" as="script"><link rel="prefetch" href="/simple-doc/assets/string.html-C763CaSa.js" as="script"><link rel="prefetch" href="/simple-doc/assets/高阶函数.html-DtFc5y2Z.js" as="script"><link rel="prefetch" href="/simple-doc/assets/bigdata-readme.html-C9tbAaC5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/dataworks.html-AGaxHToz.js" as="script"><link rel="prefetch" href="/simple-doc/assets/hive-start.html-DErgC9Uz.js" as="script"><link rel="prefetch" href="/simple-doc/assets/notice.html-DwYexM_y.js" as="script"><link rel="prefetch" href="/simple-doc/assets/resume.html-CJ0v7MKB.js" as="script"><link rel="prefetch" href="/simple-doc/assets/todo.html-BYiqLhN4.js" as="script"><link rel="prefetch" href="/simple-doc/assets/元数据管理.html-rd11M2pk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/工作流集成方案.html-DVxD1moW.js" as="script"><link rel="prefetch" href="/simple-doc/assets/数据开发.html-BHhhOvRi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/数据计算方案.html-BdPwXoYZ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/数据集成方案.html-Dub5FWqW.js" as="script"><link rel="prefetch" href="/simple-doc/assets/调度方案.html-wwwJHfKQ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-DjrpPfMq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/BlockingQueue.html-C7aU4SFG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/DeplayQueue.html-DFGB3v0a.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-fPZNLzuq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/手写线程池-思路.html-Crfr-BY5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/手写线程池.html-DWuOOXud.js" as="script"><link rel="prefetch" href="/simple-doc/assets/线程池监控2.html-GFkGF7_u.js" as="script"><link rel="prefetch" href="/simple-doc/assets/设计线程池监控.html-B2iAESuC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mmap.html-DJLTpHeR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-DE9xkrYq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/same.html-CEVSt6Al.js" as="script"><link rel="prefetch" href="/simple-doc/assets/innoDB.html-BxfdjbYx.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mvcc.html-awcIi7mS.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-45讲.html-J8oZoOv5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-Doublewrite.html-9K1Cy40j.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-b_tree-插入与页分裂.html-Bz9M-fdN.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-basic.html-C2jwPoO_.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-binlog-redolog.html-DtlSWdQe.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-buffer-pool.html-p7ONxKPQ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-bufferpool-freeflushlru.html-BBjxBLV6.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-changebuffer.html-BMFUJa_d.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-explained.html-4ad7y947.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-join.html-DSikhHZ0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-log.html-pP0NETGY.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-log对应事务.html-daqg076M.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-rbo-cbo.html-BuyVR0Aq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-sql卡住.html-D12Jodk9.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-内存自适应哈希索引.html-B2UXHC7G.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-思考整理.html-nUai5VJd.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-执行逻辑.html-COOagx0T.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-索引.html-DGeZYjJ3.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-索引失效.html-CwFYMKUi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-锁.html-BdbdhRLi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-面试题.html-JrN6b6vI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BnhbtjI-.js" as="script"><link rel="prefetch" href="/simple-doc/assets/todo.html-BFwUCOVI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/手写MySQL.html-CFWCi0iG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/反欺诈系统.html-hGJexD9t.js" as="script"><link rel="prefetch" href="/simple-doc/assets/urule.html-sGssCq0Q.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BALdRDon.js" as="script"><link rel="prefetch" href="/simple-doc/assets/tailwind-install.html-DRbPVQ9S.js" as="script"><link rel="prefetch" href="/simple-doc/assets/tailwind-official.html-aMZX-4B8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/tailwind-readme.html-CkcRcJZ5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/tailwind-todo.html-D2h1NVhz.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BPJO8Fy6.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-01.html-XvLb8dtQ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-02.html-DwcsPKT8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-basic-api.html-CUPGiR_l.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-component.html-CotAnxHn.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-deploy.html-DIPCfKFq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-LnUp5gWY.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test1.html-BI0B1Wcw.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test2.html-Br72TJbh.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test3.html-B6xlbOwB.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue-cli-command.html-fmYXaVG_.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue-cli.html-BeYWEQYC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue-crud.html-CYCr0s4B.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue-router.html-DB0Rr5ag.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue2-api.html-BS-ZbA4x.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue2-directive.html-CYp7-RH0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue2-ops.html-0n4b9IKr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue2.html-KWcI8_Di.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue3-api.html-_foiEeyL.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue3-component.html-Bb8PkRlM.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue3.html-CfJtZqbU.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vuex.html-jOJ0aMc3.js" as="script"><link rel="prefetch" href="/simple-doc/assets/resume.html-u36y829W.js" as="script"><link rel="prefetch" href="/simple-doc/assets/worker.html-CBwW3m19.js" as="script"><link rel="prefetch" href="/simple-doc/assets/some.html-BwXdzUN2.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test1.html-Da4_Zfx7.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test3.html-OLJbkEAH.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test4.html-D1RWEP5q.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vuepress-install.html-CmLdYaeX.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-CjhIQ0dl.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-C66V0ouZ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-C221oZ0f.js" as="script"><link rel="prefetch" href="/simple-doc/assets/总结.html-HTDJYTyx.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-i64IKQ3G.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vote-do.html-DSDnqVLK.js" as="script"><link rel="prefetch" href="/simple-doc/assets/docker-compose搭建环境.html-DQOqdmM5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/docker.html-B5mkBOkp.js" as="script"><link rel="prefetch" href="/simple-doc/assets/docker01.html-BEIml5Rx.js" as="script"><link rel="prefetch" href="/simple-doc/assets/data-integration.html-BXQnThwv.js" as="script"><link rel="prefetch" href="/simple-doc/assets/case1-购房群体.html-ztmUt6Lf.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter1-hadoop-hdfs.html-BvBqhSm0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter2-hadoop-yarn.html-CpeRKAq8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter3-hadoop-install-for-window.html-DC_BBhD9.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter4-hadoop2.html-Cv9_SDES.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-Drmjlpc8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/01.Hive-quickstart.html-xEt591iG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/02.Hive-ddl.html-oZcp1SJL.js" as="script"><link rel="prefetch" href="/simple-doc/assets/03.Hive-table.html-CNv8yYBJ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/04.Hive-index-view.html-CqLb37zC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/05.Hive-dml.html-7Uy6x2Jk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/06.Hive-multi-partition.html-B6eGiy2H.js" as="script"><link rel="prefetch" href="/simple-doc/assets/07.Hive-query.html-BwrwjZoi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-CltMvCVn.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter5-hive.html-BEsAjTHI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chaptere6-Hive简介及核心概念.html-D5yzNcFr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/hive-数据倾斜.html-CkSPaakF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/hadoop-install.html-Cg3Gc0pV.js" as="script"><link rel="prefetch" href="/simple-doc/assets/hive-install.html-Dz1E3_1M.js" as="script"><link rel="prefetch" href="/simple-doc/assets/01.rdd.html-ByX19H-x.js" as="script"><link rel="prefetch" href="/simple-doc/assets/01.rdd2.html-B9ucs_fO.js" as="script"><link rel="prefetch" href="/simple-doc/assets/02.dataframe.html-DXZjPIXr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/03.dataset.html-RV0pL0Y7.js" as="script"><link rel="prefetch" href="/simple-doc/assets/06.graphx.html-BLB_isWG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/07.ml.html-bwTTSJ0y.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-EventTime.html-DFFxNZ_n.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-Implementation-and-Overview.html-5CB_VNqX.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-Sink.html-DYLDSxgN.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-Source.html-DDChVqdk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-Watermark.html-CpvQB7Zf.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-stateStorage.html-PYppbO0O.js" as="script"><link rel="prefetch" href="/simple-doc/assets/broadcast.html-PV1qXZ1i.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-D5U7bFfP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-code-quick-start.html-Cvz18KMD.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-core.html-D_qK7XCT.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-core2.html-CxxZJ_6R.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-data-skew.html-BeECQwZw.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-executor.html-fWIVC2JA.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-introduce.html-CNPUv517.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-kafka.html-Bvqlayiz.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-sql.html-CFxS10Qs.js" as="script"><link rel="prefetch" href="/simple-doc/assets/todo.html-BrW3RCq1.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-kafka延迟队列.html-BZ_r3pF8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/01-02-sql执行.html-ypyCqQwC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/03-事务.html-DsUE2xMc.js" as="script"><link rel="prefetch" href="/simple-doc/assets/04-05-索引.html-b7w63ImY.js" as="script"><link rel="prefetch" href="/simple-doc/assets/06-07-锁.html-BR1EeZ2N.js" as="script"><link rel="prefetch" href="/simple-doc/assets/08-mvcc.html-Dd9DgzW4.js" as="script"><link rel="prefetch" href="/simple-doc/assets/09-普通索引和唯一索引.html-C3FV-VRB.js" as="script"><link rel="prefetch" href="/simple-doc/assets/10-12-DirtyPag脏页.html-Cbx_BzQF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/13-17-临时表.html-BQsnUS-M.js" as="script"><link rel="prefetch" href="/simple-doc/assets/18-20-索引失效.html-By2t2Fbt.js" as="script"><link rel="prefetch" href="/simple-doc/assets/21-25-mysql高可用.html-nUDGlixI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/26-27-备库.html-PEK6bhmR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/28-读写分离有哪些坑.html-g0IlOWwu.js" as="script"><link rel="prefetch" href="/simple-doc/assets/29-33-数据库问题-查询多数内存不足.html-DWxpG-Mn.js" as="script"><link rel="prefetch" href="/simple-doc/assets/34 -到底可不可以使用join.html-pAMeKwyU.js" as="script"><link rel="prefetch" href="/simple-doc/assets/35-Join语句优化.html-Cgm-FzpJ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/36-39-临时表-自增主键.html-DcIzr4JI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/40-insert语句的锁为什么这么多.html-B63BnMp0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/41-快速复制一张表.html-fXkCQd6A.js" as="script"><link rel="prefetch" href="/simple-doc/assets/42-grant之后要flush.html-CPTi5Mhd.js" as="script"><link rel="prefetch" href="/simple-doc/assets/43-分区表.html-BastDnVE.js" as="script"><link rel="prefetch" href="/simple-doc/assets/44-join问题.html-DCe6Kh5C.js" as="script"><link rel="prefetch" href="/simple-doc/assets/45-id-over.html-DJZ18FUF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-slow-log.html-BOwGVcX7.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-删除大量数据.html-oCTGHFp0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/SQLAdvisor.html-DTOR6C2j.js" as="script"><link rel="prefetch" href="/simple-doc/assets/soar.html-DysX_Ylq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/env.html-DzQdQWtp.js" as="script"><link rel="prefetch" href="/simple-doc/assets/intro.html-CecazkeR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-bUBlhSCM.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-CFwXfAJ3.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-docker-install.html-D9I2rBwk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-shell-install.html-BIlzyyeG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-standalone-install.html-CRCwPEgk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-CjMzY8Dx.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BIlrSCLb.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-DDAHSmsP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-WrfS3nKJ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BLyo2htP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/notice.html-BVj8t7x8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/todo.html-BkJYktzm.js" as="script"><link rel="prefetch" href="/simple-doc/assets/404.html-CbAexRXt.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/simple-doc/"><img class="vp-site-logo" src="/simple-doc/images/logo.png" alt="Blog"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">Blog</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/simple-doc/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/vue/" aria-label="Vue"><!--[--><!--[--><!--]--><!--]-->Vue<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/Typescript/" aria-label="TypeScript"><!--[--><!--[--><!--]--><!--]-->TypeScript<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/React/" aria-label="React"><!--[--><!--[--><!--]--><!--]-->React<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Angular"><!--[--><!--[--><!--]--><!--]-->Angular<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Node.js"><!--[--><!--[--><!--]--><!--]-->Node.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="小程序"><!--[--><!--[--><!--]--><!--]-->小程序<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Flutter"><!--[--><!--[--><!--]--><!--]-->Flutter<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据开发"><span class="title">数据开发</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据开发"><span class="title">数据开发</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/datawarehouse/" aria-label="数据产品"><!--[--><!--[--><!--]--><!--]-->数据产品<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><a class="route-link auto-link" href="/simple-doc/guide/etl/bigdata-readme.html" aria-label="大数据"><!--[--><!--[--><!--]--><!--]-->大数据<!--[--><!--[--><!--]--><!--]--></a></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/hadoop/" aria-label="Hadoop"><!--[--><!--[--><!--]--><!--]-->Hadoop<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/hive/" aria-label="Hive"><!--[--><!--[--><!--]--><!--]-->Hive<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/simple-doc/guide/etl/spark/" aria-label="Spark"><!--[--><!--[--><!--]--><!--]-->Spark<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/mysql/" aria-label="MySQL"><!--[--><!--[--><!--]--><!--]-->MySQL<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Redis"><!--[--><!--[--><!--]--><!--]-->Redis<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="后端"><span class="title">后端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="后端"><span class="title">后端</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Python"><!--[--><!--[--><!--]--><!--]-->Python<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Golang"><!--[--><!--[--><!--]--><!--]-->Golang<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/GavinAlison2" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/simple-doc/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/vue/" aria-label="Vue"><!--[--><!--[--><!--]--><!--]-->Vue<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/Typescript/" aria-label="TypeScript"><!--[--><!--[--><!--]--><!--]-->TypeScript<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/React/" aria-label="React"><!--[--><!--[--><!--]--><!--]-->React<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Angular"><!--[--><!--[--><!--]--><!--]-->Angular<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Node.js"><!--[--><!--[--><!--]--><!--]-->Node.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="小程序"><!--[--><!--[--><!--]--><!--]-->小程序<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Flutter"><!--[--><!--[--><!--]--><!--]-->Flutter<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据开发"><span class="title">数据开发</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据开发"><span class="title">数据开发</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/datawarehouse/" aria-label="数据产品"><!--[--><!--[--><!--]--><!--]-->数据产品<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><a class="route-link auto-link" href="/simple-doc/guide/etl/bigdata-readme.html" aria-label="大数据"><!--[--><!--[--><!--]--><!--]-->大数据<!--[--><!--[--><!--]--><!--]--></a></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/hadoop/" aria-label="Hadoop"><!--[--><!--[--><!--]--><!--]-->Hadoop<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/hive/" aria-label="Hive"><!--[--><!--[--><!--]--><!--]-->Hive<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/simple-doc/guide/etl/spark/" aria-label="Spark"><!--[--><!--[--><!--]--><!--]-->Spark<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/mysql/" aria-label="MySQL"><!--[--><!--[--><!--]--><!--]-->MySQL<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Redis"><!--[--><!--[--><!--]--><!--]-->Redis<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="后端"><span class="title">后端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="后端"><span class="title">后端</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Python"><!--[--><!--[--><!--]--><!--]-->Python<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Golang"><!--[--><!--[--><!--]--><!--]-->Golang<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/GavinAlison2" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading" href="/simple-doc/guide/etl/spark/" aria-label="Spark 学习笔记"><!--[--><!--[--><!--]--><!--]-->Spark 学习笔记<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="streaming" tabindex="-1"><a class="header-anchor" href="#streaming"><span>Streaming</span></a></h1><h2 id="spark-streaming-是什么" tabindex="-1"><a class="header-anchor" href="#spark-streaming-是什么"><span>Spark Streaming 是什么</span></a></h2><p>​ Spark 流使得构建可扩展的容错流应用程序变得更加容易。Spark Streaming 用于流式数据的处理。Spark Streaming 支持的数据输入源很多，例如：Kafka、Flume、Twitter、ZeroMQ 和简单的 TCP 套接字等等。数据输入后可以用 Spark 的高度抽象原语如：map、reduce、join、window 等进行运算。而结果也能保存在很多地方，如 HDFS，数据库等。和 Spark 基于 RDD 的概念很相似，Spark Streaming 使用离散化流(discretized stream)作为抽象表示，叫作 DStream。DStream 是随时间推移而收到的数据的序列。在内部，每个时间区间收到的数据都作为 RDD 存在，而 DStream 是由这些 RDD 所组成的序列(因此得名“离散化”)。所以简单来讲，DStream 就是对 RDD 在实时数据处理场景的一种封装。</p><h2 id="spark-streaming-的特点" tabindex="-1"><a class="header-anchor" href="#spark-streaming-的特点"><span>Spark Streaming 的特点</span></a></h2><ul><li>易用</li><li>容错</li><li>易整合到 Spark 体系</li></ul><h2 id="spark-streaming-架构" tabindex="-1"><a class="header-anchor" href="#spark-streaming-架构"><span>Spark Streaming 架构</span></a></h2><p><img src="/simple-doc/assets/20250419113150-BDdAX0wF.png" alt="arch"></p><h3 id="背压机制" tabindex="-1"><a class="header-anchor" href="#背压机制"><span>背压机制</span></a></h3><p>Spark 1.5 以前版本，用户如果要限制 Receiver 的数据接收速率，可以通过设置静态配制参数“spark.streaming.receiver.maxRate”的值来实现，此举虽然可以通过限制接收速率，来适配当前的处理能力，防止内存溢出，但也会引入其它问题。比如：producer 数据生产高于 maxRate，当前集群处理能力也高于 maxRate，这就会造成资源利用率下降等问题。为了更好的协调数据接收速率与资源处理能力，1.5 版本开始 Spark Streaming 可以动态控制数据接收速率来适配集群数据处理能力。背压机制（即 Spark Streaming Backpressure）: 根据JobScheduler 反馈作业的执行信息来动态调整 Receiver 数据接收率。通过属性“spark.streaming.backpressure.enabled”来控制是否启用 backpressure 机制，默认值false，即不启用。</p><h1 id="第-2-章-dstream-入门" tabindex="-1"><a class="header-anchor" href="#第-2-章-dstream-入门"><span>第 2 章 Dstream 入门</span></a></h1><h2 id="_2-1-wordcount-案例实操" tabindex="-1"><a class="header-anchor" href="#_2-1-wordcount-案例实操"><span>2.1 WordCount 案例实操</span></a></h2><p>➢ 需求：使用 netcat 工具向 9999 端口不断的发送数据，通过 SparkStreaming 读取端口数据并 统计不同单词出现的次数</p><ol><li>添加依赖</li></ol><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>编写代码</li></ol><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">object</span> StreamWordCount <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1.初始化 Spark 配置信息</span></span>
<span class="line">        <span class="token keyword">val</span> sparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;StreamWordCount&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//2.初始化 SparkStreamingContext</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//3.通过监控端口创建 DStream，读进来的数据为一行行</span></span>
<span class="line">        <span class="token keyword">val</span> lineStreams <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;linux1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//将每一行数据做切分，形成一个个单词</span></span>
<span class="line">        <span class="token keyword">val</span> wordStreams <span class="token operator">=</span> lineStreams<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//将单词映射成元组（word,1）</span></span>
<span class="line">        <span class="token keyword">val</span> wordAndOneStreams <span class="token operator">=</span> wordStreams<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//将相同的单词次数做统计</span></span>
<span class="line">        <span class="token keyword">val</span> wordAndCountStreams <span class="token operator">=</span> wordAndOneStreams<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_<span class="token operator">+</span>_<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//打印</span></span>
<span class="line">        wordAndCountStreams<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//启动 SparkStreamingContext</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>启动程序并通过 netcat 发送数据：</li></ol><blockquote><p>nc -lk 9999 hello spark</p></blockquote><h2 id="_2-2-wordcount-解析" tabindex="-1"><a class="header-anchor" href="#_2-2-wordcount-解析"><span>2.2 WordCount 解析</span></a></h2><blockquote><p>Discretized Stream 是 Spark Streaming 的基础抽象，代表持续性的数据流和经过各种 Spark 原语操作后的结果数据流。在内部实现上，DStream 是一系列连续的 RDD 来表示。每个 RDD 含有一段时间间隔内的数据。对数据的操作也是按照 RDD 为单位来进行的计算过程由 <code>Spark Engine</code> 来完成</p></blockquote><h1 id="第-3-章-dstream-创建" tabindex="-1"><a class="header-anchor" href="#第-3-章-dstream-创建"><span>第 3 章 DStream 创建</span></a></h1><h2 id="_3-1-rdd-队列" tabindex="-1"><a class="header-anchor" href="#_3-1-rdd-队列"><span>3.1 RDD 队列</span></a></h2><h3 id="_3-1-1-用法及说明" tabindex="-1"><a class="header-anchor" href="#_3-1-1-用法及说明"><span>3.1.1 用法及说明</span></a></h3><blockquote><p>测试过程中，可以通过使用 ssc.queueStream(queueOfRDDs)来创建 DStream，每一个推送到这个队列中的 RDD，都会作为一个 DStream 处理。</p></blockquote><h3 id="_3-1-2-案例实操" tabindex="-1"><a class="header-anchor" href="#_3-1-2-案例实操"><span>3.1.2 案例实操</span></a></h3><p>➢ 需求：循环创建几个 RDD，将 RDD 放入队列。通过 SparkStream 创建 Dstream，计算 WordCount</p><ol><li>编写代码</li></ol><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">object</span> RDDStream <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1.初始化 Spark 配置信息</span></span>
<span class="line">        <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;RDDStream&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//2.初始化 SparkStreamingContext</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//3.创建 RDD 队列</span></span>
<span class="line">        <span class="token keyword">val</span> rddQueue <span class="token operator">=</span> <span class="token keyword">new</span> mutable<span class="token punctuation">.</span>Queue<span class="token punctuation">[</span>RDD<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//4.创建 QueueInputDStream</span></span>
<span class="line">        <span class="token keyword">val</span> inputStream <span class="token operator">=</span> ssc<span class="token punctuation">.</span>queueStream<span class="token punctuation">(</span>rddQueue<span class="token punctuation">,</span>oneAtATime <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//5.处理队列中的 RDD 数据</span></span>
<span class="line">        <span class="token keyword">val</span> mappedStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">val</span> reducedStream <span class="token operator">=</span> mappedStream<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//6.打印结果</span></span>
<span class="line">        reducedStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//7.启动任务</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//8.循环创建并向 RDD 队列中放入 RDD</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            rddQueue <span class="token operator">+=</span> ssc<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span><span class="token number">1</span> to <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line">            Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>结果展示</li></ol><h2 id="_3-2-自定义数据源" tabindex="-1"><a class="header-anchor" href="#_3-2-自定义数据源"><span>3.2 自定义数据源</span></a></h2><h3 id="_3-2-1-用法及说明" tabindex="-1"><a class="header-anchor" href="#_3-2-1-用法及说明"><span>3.2.1 用法及说明</span></a></h3><p>需要继承 Receiver，并实现 onStart、onStop 方法来自定义数据源采集。</p><h3 id="_3-2-2-案例实操" tabindex="-1"><a class="header-anchor" href="#_3-2-2-案例实操"><span>3.2.2 案例实操</span></a></h3><p>需求：<code>自定义数据源</code>，实现监控某个端口号，获取该端口号内容。</p><ol><li>自定义数据源</li></ol><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">class</span> CustomerReceiver<span class="token punctuation">(</span>host<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> port<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Receiver<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>StorageLevel<span class="token punctuation">.</span>MEMORY_ONLY<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//最初启动的时候，调用该方法，作用为：读数据并将数据发送给 Spark</span></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">def</span> onStart<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">new</span> Thread<span class="token punctuation">(</span><span class="token string">&quot;Socket Receiver&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                receive<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//读数据并将数据发送给 Spark</span></span>
<span class="line">    <span class="token keyword">def</span> receive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//创建一个 Socket</span></span>
<span class="line">        <span class="token keyword">var</span> socket<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token keyword">new</span> Socket<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//定义一个变量，用来接收端口传过来的数据</span></span>
<span class="line">        <span class="token keyword">var</span> input<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">        <span class="token comment">//创建一个 BufferedReader 用于读取端口传来的数据</span></span>
<span class="line">        <span class="token keyword">val</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> BufferedReader<span class="token punctuation">(</span><span class="token keyword">new</span> InputStreamReader<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>getInputStream<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//读取数据</span></span>
<span class="line">        input <span class="token operator">=</span> reader<span class="token punctuation">.</span>readLine<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//当 receiver 没有关闭并且输入数据不为空，则循环发送数据给 Spark</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>isStopped<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> input <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            store<span class="token punctuation">(</span>input<span class="token punctuation">)</span></span>
<span class="line">            input <span class="token operator">=</span> reader<span class="token punctuation">.</span>readLine<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//跳出循环则关闭资源</span></span>
<span class="line">        reader<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//重启任务</span></span>
<span class="line">        restart<span class="token punctuation">(</span><span class="token string">&quot;restart&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">override</span> <span class="token keyword">def</span> onStop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>使用自定义的数据源采集数据</li></ol><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">object</span> FileStream <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1.初始化 Spark 配置信息</span></span>
<span class="line">        <span class="token keyword">val</span> sparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;StreamWordCount&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//2.初始化 SparkStreamingContext</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//3.创建自定义 receiver 的 Streaming</span></span>
<span class="line">        <span class="token keyword">val</span> lineStream <span class="token operator">=</span> ssc<span class="token punctuation">.</span>receiverStream<span class="token punctuation">(</span><span class="token keyword">new</span> CustomerReceiver<span class="token punctuation">(</span><span class="token string">&quot;hadoop102&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//4.将每一行数据做切分，形成一个个单词</span></span>
<span class="line">        <span class="token keyword">val</span> wordStream <span class="token operator">=</span> lineStream<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\t&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//5.将单词映射成元组（word,1）</span></span>
<span class="line">        <span class="token keyword">val</span> wordAndOneStream <span class="token operator">=</span> wordStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//6.将相同的单词次数做统计</span></span>
<span class="line">        <span class="token keyword">val</span> wordAndCountStream <span class="token operator">=</span> wordAndOneStream<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//7.打印</span></span>
<span class="line">        wordAndCountStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//8.启动 SparkStreamingContext</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-3-kafka-数据源" tabindex="-1"><a class="header-anchor" href="#_3-3-kafka-数据源"><span>3.3 Kafka 数据源</span></a></h2><h3 id="_3-3-1-版本选型" tabindex="-1"><a class="header-anchor" href="#_3-3-1-版本选型"><span>3.3.1 版本选型</span></a></h3><blockquote><p>​ <code>ReceiverAPI</code>：需要一个专门的 Executor 去接收数据，然后发送给其他的 Executor 做计算。存在的问题，接收数据的 Executor 和计算的 Executor 速度会有所不同，特别在接收数据的 Executor速度大于计算的 Executor 速度，会导致计算数据的节点内存溢出。早期版本中提供此方式，当前版本不适用 ​ <code>DirectAPI</code>：是由计算的 Executor 来主动消费 Kafka 的数据，速度由自身控制。</p></blockquote><h3 id="_3-3-2-kafka-0-8-receiver-模式-当前版本不适用" tabindex="-1"><a class="header-anchor" href="#_3-3-2-kafka-0-8-receiver-模式-当前版本不适用"><span>3.3.2 Kafka 0-8 Receiver 模式（当前版本不适用）</span></a></h3><p>1） 需求：通过 SparkStreaming 从 Kafka 读取数据，并将读取过来的数据做简单计算，最终打印到控制台。</p><p>2）导入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming-kafka-0-8_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）编写代码</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>ReceiverInputDStream</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span>KafkaUtils</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> ReceiverAPI <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1.创建 SparkConf</span></span>
<span class="line">        <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;ReceiverWordCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//2.创建 StreamingContext</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//3.读取 Kafka 数据创建 DStream(基于 Receive 方式)</span></span>
<span class="line">        <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">        KafkaUtils<span class="token punctuation">.</span>createStream<span class="token punctuation">(</span>ssc<span class="token punctuation">,</span><span class="token string">&quot;linux1:2181,linux2:2181,linux3:2181&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">,</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;atguigu&quot;</span> <span class="token operator">-&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//4.计算 WordCount</span></span>
<span class="line">        kafkaDStream<span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span> <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//5.开启任务</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-3-kafka-0-8-direct-模式-当前版本不适用" tabindex="-1"><a class="header-anchor" href="#_3-3-3-kafka-0-8-direct-模式-当前版本不适用"><span>3.3.3 Kafka 0-8 Direct 模式（当前版本不适用）</span></a></h3><p>1）需求：通过 SparkStreaming 从 Kafka 读取数据，并将读取过来的数据做简单计算，最终打印到控制台。</p><p>2）导入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming-kafka-0-8_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）编写代码（自动维护 offset）</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">kafka<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span>StringDecoder</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerConfig</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>InputDStream</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span>KafkaUtils</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> DirectAPIAuto02 <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">val</span> getSSC1<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> StreamingContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;ReceiverWordCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        ssc</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">def</span> getSSC<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1.创建 SparkConf</span></span>
<span class="line">        <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;ReceiverWordCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//2.创建 StreamingContext</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//设置 CK</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;./ck2&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//3.定义 Kafka 参数</span></span>
<span class="line">        <span class="token keyword">val</span> kafkaPara<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ConsumerConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG <span class="token operator">-&gt;</span> <span class="token string">&quot;linux1:9092,linux2:9092,linux3:9092&quot;</span><span class="token punctuation">,</span></span>
<span class="line"> ConsumerConfig<span class="token punctuation">.</span>GROUP_ID_CONFIG <span class="token operator">-&gt;</span> <span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//4.读取 Kafka 数据</span></span>
<span class="line">        <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> StringDecoder<span class="token punctuation">,</span> StringDecoder<span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>kafkaPara<span class="token punctuation">,</span> Set<span class="token punctuation">(</span><span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//5.计算 WordCount</span></span>
<span class="line">        kafkaDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//6.返回数据</span></span>
<span class="line">        ssc</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取 SSC</span></span>
<span class="line">        <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> StreamingContext<span class="token punctuation">.</span>getActiveOrCreate<span class="token punctuation">(</span><span class="token string">&quot;./ck2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> getSSC<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//开启任务</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）编写代码（手动维护 offset）</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>TopicAndPartition</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">kafka<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span>MessageAndMetadata</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">kafka<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span>StringDecoder</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerConfig</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token punctuation">{</span>HasOffsetRanges<span class="token punctuation">,</span> KafkaUtils<span class="token punctuation">,</span></span>
<span class="line">OffsetRange<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> DirectAPIHandler <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//1.创建 SparkConf</span></span>
<span class="line"> <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> </span>
<span class="line">SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;ReceiverWordCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//2.创建 StreamingContext</span></span>
<span class="line"> <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"> <span class="token comment">//3.Kafka 参数</span></span>
<span class="line"> <span class="token keyword">val</span> kafkaPara<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span></span>
<span class="line"> ConsumerConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG <span class="token operator">-&gt;</span> </span>
<span class="line"><span class="token string">&quot;hadoop102:9092,hadoop103:9092,hadoop104:9092&quot;</span><span class="token punctuation">,</span></span>
<span class="line"> ConsumerConfig<span class="token punctuation">.</span>GROUP_ID_CONFIG <span class="token operator">-&gt;</span> <span class="token string">&quot;atguigu&quot;</span></span>
<span class="line"> <span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//4.获取上一次启动最后保留的 Offset=&gt;getOffset(MySQL)</span></span>
<span class="line"> <span class="token keyword">val</span> fromOffsets<span class="token operator">:</span> Map<span class="token punctuation">[</span>TopicAndPartition<span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">[</span>TopicAndPartition<span class="token punctuation">,</span> </span>
<span class="line"><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">(</span>TopicAndPartition<span class="token punctuation">(</span><span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//5.读取 Kafka 数据创建 DStream</span></span>
<span class="line"> <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> </span>
<span class="line"><span class="token builtin">String</span><span class="token punctuation">,</span> StringDecoder<span class="token punctuation">,</span> StringDecoder<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span></span>
<span class="line"> kafkaPara<span class="token punctuation">,</span></span>
<span class="line"> fromOffsets<span class="token punctuation">,</span></span>
<span class="line"> <span class="token punctuation">(</span>m<span class="token operator">:</span> MessageAndMetadata<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> m<span class="token punctuation">.</span>message<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//6.创建一个数组用于存放当前消费数据的 offset 信息</span></span>
<span class="line"> <span class="token keyword">var</span> offsetRanges <span class="token operator">=</span> Array<span class="token punctuation">.</span>empty<span class="token punctuation">[</span>OffsetRange<span class="token punctuation">]</span></span>
<span class="line"> <span class="token comment">//7.获取当前消费数据的 offset 信息</span></span>
<span class="line"> <span class="token keyword">val</span> wordToCountDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> kafkaDStream<span class="token punctuation">.</span>transform <span class="token punctuation">{</span> rdd </span>
<span class="line"><span class="token keyword">=&gt;</span></span>
<span class="line"> offsetRanges <span class="token operator">=</span> rdd<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>HasOffsetRanges<span class="token punctuation">]</span><span class="token punctuation">.</span>offsetRanges</span>
<span class="line"> rdd</span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//8.打印 Offset 信息</span></span>
<span class="line"> wordToCountDStream<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">for</span> <span class="token punctuation">(</span>o <span class="token keyword">&lt;-</span> offsetRanges<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">o<span class="token punctuation">.</span>topic</span><span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">o<span class="token punctuation">.</span>partition</span><span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">o<span class="token punctuation">.</span>fromOffset</span><span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">o<span class="token punctuation">.</span>untilOffset</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> rdd<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//9.开启任务</span></span>
<span class="line"> ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-4-kafka-0-10-direct-模式" tabindex="-1"><a class="header-anchor" href="#_3-3-4-kafka-0-10-direct-模式"><span>3.3.4 Kafka 0-10 Direct 模式</span></a></h3><p>1）需求：通过 SparkStreaming 从 Kafka 读取数据，并将读取过来的数据做简单计算，最终打印到控制台。 2）导入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming-kafka-0-10_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）编写代码</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ConsumerConfig<span class="token punctuation">,</span> ConsumerRecord<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ConsumerStrategies<span class="token punctuation">,</span> KafkaUtils<span class="token punctuation">,</span> LocationStrategies<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> DirectAPI <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1.创建 SparkConf</span></span>
<span class="line">        <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;ReceiverWordCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//2.创建 StreamingContext</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//3.定义 Kafka 参数</span></span>
<span class="line">        <span class="token keyword">val</span> kafkaPara<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">(</span>ConsumerConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG <span class="token operator">-&gt;</span> <span class="token string">&quot;linux1:9092,linux2:9092,linux3:9092&quot;</span><span class="token punctuation">,</span>ConsumerConfig<span class="token punctuation">.</span>GROUP_ID_CONFIG <span class="token operator">-&gt;</span> <span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;key.deserializer&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;value.deserializer&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//4.读取 Kafka 数据创建 DStream</span></span>
<span class="line">        <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span>ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Set<span class="token punctuation">(</span><span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaPara<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//5.将每条消息的 KV 取出</span></span>
<span class="line">        <span class="token keyword">val</span> valueDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> kafkaDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//6.计算 WordCount</span></span>
<span class="line">        valueDStream<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//7.开启任务</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看 Kafka 消费进度 bin/kafka-consumer-groups.sh --describe --bootstrap-server linux1:9092 --group atguigu</p><h1 id="第-4-章-dstream-转换" tabindex="-1"><a class="header-anchor" href="#第-4-章-dstream-转换"><span>第 4 章 DStream 转换</span></a></h1><blockquote><p>​ DStream 上的操作与 RDD 的类似，分为 Transformations（转换）和 Output Operations（输出）两种，此外转换操作中还有一些比较特殊的原语，如：updateStateByKey()、transform()以及各种 Window 相关的原语。</p></blockquote><h2 id="_4-1-无状态转化操作" tabindex="-1"><a class="header-anchor" href="#_4-1-无状态转化操作"><span>4.1 无状态转化操作</span></a></h2><blockquote><p>​ 无状态转化操作就是把简单的 RDD 转化操作应用到每个批次上，也就是转化 DStream 中的每一个 RDD。部分无状态转化操作列在了下表中。注意，针对键值对的 DStream 转化操作(比如reduceByKey())要添加 import StreamingContext._才能在 Scala 中使用。需要记住的是，尽管这些函数看起来像作用在整个流上一样，但事实上每个 DStream 在内部是由许多 RDD（批次）组成，且无状态转化操作是分别应用到每个 RDD 上的。例如：reduceByKey()会归约每个时间区间中的数据，但不会归约不同区间之间的数据。</p></blockquote><h3 id="_4-1-1-transform" tabindex="-1"><a class="header-anchor" href="#_4-1-1-transform"><span>4.1.1 Transform</span></a></h3><blockquote><p>​ Transform 允许 DStream 上执行任意的 RDD-to-RDD 函数。即使这些函数并没有在 DStream的 API 中暴露出来，通过该函数可以方便的扩展 Spark API。该函数每一批次调度一次。其实也就是对 DStream 中的 RDD 应用转换。</p></blockquote><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">object</span> Transform <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//创建 SparkConf</span></span>
<span class="line">        <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;WordCount&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//创建 StreamingContext</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//创建 DStream</span></span>
<span class="line">        <span class="token keyword">val</span> lineDStream<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;linux1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//转换为 RDD 操作</span></span>
<span class="line">        <span class="token keyword">val</span> wordAndCountDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> lineDStream<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">val</span> words<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdd<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">val</span> wordAndOne<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> words<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">val</span> value<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> wordAndOne<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line">            value</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//打印</span></span>
<span class="line">        wordAndCountDStream<span class="token punctuation">.</span>print</span>
<span class="line">        <span class="token comment">//启动</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-1-2-join" tabindex="-1"><a class="header-anchor" href="#_4-1-2-join"><span>4.1.2 join</span></a></h3><blockquote><p>​ 两个流之间的 join 需要两个流的<code>批次大小一致</code>，这样才能做到同时触发计算。计算过程就是对当前批次的两个流中各自的 RDD 进行 join，与两个 RDD 的 join 效果相同。</p></blockquote><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> JoinTest <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1.创建 SparkConf</span></span>
<span class="line">        <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;JoinTest&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//2.创建 StreamingContext</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//3.从端口获取数据创建流</span></span>
<span class="line">        <span class="token keyword">val</span> lineDStream1<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;linux1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">val</span> lineDStream2<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;linux2&quot;</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//4.将两个流转换为 KV 类型</span></span>
<span class="line">        <span class="token keyword">val</span> wordToOneDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> lineDStream1<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">val</span> wordToADStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> lineDStream2<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//5.流的 JOIN</span></span>
<span class="line">        <span class="token keyword">val</span> joinDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> wordToOneDStream<span class="token punctuation">.</span>join<span class="token punctuation">(</span>wordToADStream<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//6.打印</span></span>
<span class="line">        joinDStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//7.启动任务</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-2-有状态转化操作" tabindex="-1"><a class="header-anchor" href="#_4-2-有状态转化操作"><span>4.2 有状态转化操作</span></a></h2><h3 id="_4-2-1-updatestatebykey" tabindex="-1"><a class="header-anchor" href="#_4-2-1-updatestatebykey"><span>4.2.1 UpdateStateByKey</span></a></h3><p>UpdateStateByKey 原语用于记录历史记录，有时，我们需要在 DStream 中跨批次<code>维护状态</code>(例如流计算中累加 wordcount)。</p><p>针对这种情况，updateStateByKey()为我们提供了对一个状态变量的访问，用于键值对形式的 DStream。</p><p>给定一个由(键，事件)对构成的 DStream，并传递一个指定如何根据新的事件更新每个键对应状态的函数，它可以构建出一个新的 DStream，其内部数据为(键，状态) 对。</p><p>updateStateByKey() 的结果会是一个新的 DStream，其内部的 RDD 序列是由每个时间区间对应的(键，状态)对组成的。</p><p>updateStateByKey 操作使得我们可以在用新信息进行更新时保持任意的状态。为使用这个功能，需要做下面两步：</p><ol><li><p>定义状态，状态可以是一个任意的数据类型。</p></li><li><p>定义状态更新函数，用此函数阐明如何使用之前的状态和来自输入流的新值对状态进行更新。使用 <code>updateStateByKey</code> 需要对检查点目录进行配置，会使用检查点来保存状态。更新版的 wordcount</p></li></ol><ol><li>编写代码</li></ol><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line">   <span class="token keyword">object</span> WorldCount <span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">           <span class="token comment">// 定义更新状态方法，参数 values 为当前批次单词频度，state 为以往批次单词频度</span></span>
<span class="line">            <span class="token keyword">val</span> updateFunc <span class="token operator">=</span> <span class="token punctuation">(</span>values<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> state<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">val</span> currentCount <span class="token operator">=</span> values<span class="token punctuation">.</span>foldLeft<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">val</span> previousCount <span class="token operator">=</span> state<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                Some<span class="token punctuation">(</span>currentCount <span class="token operator">+</span> previousCount<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;NetworkWordCount&quot;</span><span class="token punctuation">)</span></span>
<span class="line">           <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">           ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;./ck&quot;</span><span class="token punctuation">)</span></span>
<span class="line">           <span class="token comment">// Create a DStream that will connect to hostname:port, like hadoop102:9999</span></span>
<span class="line">            <span class="token keyword">val</span> lines <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;linux1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// Split each line into words</span></span>
<span class="line">            <span class="token keyword">val</span> words <span class="token operator">=</span> lines<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">//import org.apache.spark.streaming.StreamingContext._ </span></span>
<span class="line">            <span class="token comment">// not necessary since Spark 1.3</span></span>
<span class="line">            <span class="token comment">// Count each word in each batch</span></span>
<span class="line">            <span class="token keyword">val</span> pairs <span class="token operator">=</span> words<span class="token punctuation">.</span>map<span class="token punctuation">(</span>word <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// 使用 updateStateByKey 来更新状态，统计从运行开始以来单词总的次数</span></span>
<span class="line">            <span class="token keyword">val</span> stateDstream <span class="token operator">=</span> pairs<span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span></span>
<span class="line">            stateDstream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Start the computation</span></span>
<span class="line">            ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Wait for the computation to terminate</span></span>
<span class="line">            <span class="token comment">//ssc.stop()</span></span>
<span class="line">        <span class="token punctuation">}</span> </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>启动程序并向 9999 端口发送数据</li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">nc -lk 9999</span>
<span class="line">Hello World</span>
<span class="line">Hello Scala</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>结果展示</li></ol><h3 id="_4-2-2-windowoperations" tabindex="-1"><a class="header-anchor" href="#_4-2-2-windowoperations"><span>4.2.2 WindowOperations</span></a></h3><p>​ Window Operations 可以设置窗口的大小和滑动窗口的间隔来动态的获取当前 Steaming 的允许状态。所有基于窗口的操作都需要两个参数，分别为窗口时长以及滑动步长。</p><p>➢ 窗口时长：计算内容的时间范围；</p><p>➢ 滑动步长：隔多久触发一次计算。 注意：这两者都必须为<code>采集周期</code>大小的整数倍。WordCount 第三版：3 秒一个批次，窗口 12 秒，滑步 6 秒。</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">object</span> WorldCount <span class="token punctuation">{</span></span>
<span class="line">     <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[2]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;NetworkWordCount&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">         ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;./ck&quot;</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token comment">// Create a DStream that will connect to hostname:port, like localhost:9999</span></span>
<span class="line">         <span class="token keyword">val</span> lines <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;linux1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token comment">// Split each line into words</span></span>
<span class="line">         <span class="token keyword">val</span> words <span class="token operator">=</span> lines<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token comment">// Count each word in each batch</span></span>
<span class="line">        <span class="token keyword">val</span> pairs <span class="token operator">=</span> words<span class="token punctuation">.</span>map<span class="token punctuation">(</span>word <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">val</span> wordCounts <span class="token operator">=</span> pairs<span class="token punctuation">.</span>reduceByKeyAndWindow<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>b<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token comment">// Print the first ten elements of each RDD generated in this DStream to the console</span></span>
<span class="line">        wordCounts<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">         ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Start the computation</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Wait for the computation to terminate</span></span>
<span class="line">     <span class="token punctuation">}</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于 Window 的操作还有如下方法：</p><p>（1）<code>window(windowLength, slideInterval)</code>: 基于对源 DStream 窗化的批次进行计算返回一个新的 Dstream；</p><p>（2）<code>countByWindow(windowLength, slideInterval)</code>: 返回一个滑动窗口计数流中的元素个数；</p><p>（3）<code>reduceByWindow(func, windowLength, slideInterval)</code>: 通过使用自定义函数整合滑动区间流元素来创建一个新的单元素流；</p><p>（4）<code>reduceByKeyAndWindow(func, windowLength, slideInterval, [numTasks])</code>: 当在一个(K,V)对的 DStream 上调用此函数，会返回一个新(K,V)对的 DStream，此处通过对滑动窗口中批次数据使用 reduce 函数来整合每个 key 的 value 值。</p><p>（5）<code>reduceByKeyAndWindow(func, invFunc, windowLength, slideInterval, [numTasks])</code>: 这个函数是上述函数的变化版本，每个窗口的 reduce 值都是通过用前一个窗的 reduce 值来递增计算。通过 reduce 进入到滑动窗口数据并”反向 reduce”离开窗口的旧数据来实现这个操作。</p><p>​ 一个例子是随着窗口滑动对 keys 的“加”“减”计数。通过前边介绍可以想到，这个函数只适用于”可逆的 reduce 函数”，也就是这些 reduce 函数有相应的”反 reduce”函数(以参数 invFunc 形式传入)。</p><p>如前述函数，reduce 任务的数量通过可选参数来配置。</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">val</span> ipDStream <span class="token operator">=</span> accessLogsDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>logEntry <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>logEntry<span class="token punctuation">.</span>getIpAddress<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">val</span> ipCountDStream <span class="token operator">=</span> ipDStream<span class="token punctuation">.</span>reduceByKeyAndWindow<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> x <span class="token operator">+</span> y<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> x <span class="token operator">-</span> y<span class="token punctuation">}</span><span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">//加上新进入窗口的批次中的元素 </span></span>
<span class="line"><span class="token comment">//移除离开窗口的老批次中的元素 </span></span>
<span class="line"><span class="token comment">//窗口时长</span></span>
<span class="line"><span class="token comment">// 滑动步长</span></span>
<span class="line"><span class="token comment">// countByWindow()和 countByValueAndWindow()作为对数据进行计数操作的简写。</span></span>
<span class="line"><span class="token comment">// countByWindow()返回一个表示每个窗口中元素个数的 DStream，而 countByValueAndWindow()</span></span>
<span class="line"><span class="token comment">// 返回的 DStream 则包含窗口中每个值的个数。</span></span>
<span class="line"> <span class="token keyword">val</span> ipDStream <span class="token operator">=</span> accessLogsDStream<span class="token punctuation">.</span>map<span class="token punctuation">{</span>entry <span class="token keyword">=&gt;</span> entry<span class="token punctuation">.</span>getIpAddress<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line"> <span class="token keyword">val</span> ipAddressRequestCount <span class="token operator">=</span> ipDStream<span class="token punctuation">.</span>countByValueAndWindow<span class="token punctuation">(</span>Seconds<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line"> Seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span>
<span class="line">  <span class="token keyword">val</span> requestCount <span class="token operator">=</span> accessLogsDStream<span class="token punctuation">.</span>countByWindow<span class="token punctuation">(</span>Seconds<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="第-5-章-dstream-输出" tabindex="-1"><a class="header-anchor" href="#第-5-章-dstream-输出"><span>第 5 章 DStream 输出</span></a></h1><p>​ 输出操作指定了对流数据经转化操作得到的数据所要执行的操作(例如把结果推入外部数据库或输出到屏幕上)。与 RDD 中的惰性求值类似，如果一个 DStream 及其派生出的 DStream 都没有被执行输出操作，那么这些 DStream 就都不会被求值。如果 StreamingContext 中没有设定输出操作，整个 context 就都不会启动。</p><p>输出操作如下：</p><p>➢ print()：在运行流程序的驱动结点上打印 DStream 中每一批次数据的最开始 10 个元素。这用于开发和调试。在 Python API 中，同样的操作叫 print()。</p><p>➢ saveAsTextFiles(prefix, [suffix])：以 text 文件形式存储这个 DStream 的内容。每一批次的存储文件名基于参数中的 prefix 和 suffix。”prefix-Time_IN_MS[.suffix]”。</p><p>➢ saveAsObjectFiles(prefix, [suffix])：以 Java 对象序列化的方式将 Stream 中的数据保存为SequenceFiles . 每一批次的存储文件名基于参数中的为&quot;prefix-TIME_IN_MS[.suffix]&quot;. Python中目前不可用。</p><p>➢ saveAsHadoopFiles(prefix, [suffix])：将 Stream 中的数据保存为 Hadoop files. 每一批次的存 储文件名基于参数中的为&quot;prefix-TIME_IN_MS[.suffix]&quot;。Python API 中目前不可用。</p><p>➢ foreachRDD(func)：这是<strong>最通用的输出操</strong>作，即将函数 func 用于产生于 stream 的每一个RDD。其中参数传入的函数 func 应该实现将每一个 RDD 中数据推<strong>送到外部系统</strong>，如将RDD 存入文件或者通过网络将其写入数据库。通用的输出操作foreachRDD()，它用来对 DStream 中的 RDD 运行任意计算。这和 transform() 有些类似，都可以让我们访问任意 RDD。在 foreachRDD()中，可以重用我们在 Spark 中实现的所有行动操作。比如，常见的用例之一是把数据写到诸如 MySQL 的外部数据库中。</p><p>注意：</p><ol><li>连接不能写在 driver 层面（序列化）</li><li>如果写在 foreach 则每个 RDD 中的每一条数据都创建，得不偿失；</li><li>增加 foreachPartition，在分区创建（获取）。</li></ol><h1 id="第-6-章-优雅关闭" tabindex="-1"><a class="header-anchor" href="#第-6-章-优雅关闭"><span>第 6 章 优雅关闭</span></a></h1><p>​ 流式任务需要 7*24 小时执行，但是有时涉及到升级代码需要主动停止程序，但是分布式程序，没办法做到一个个进程去杀死，所有配置优雅的关闭就显得至关重要了。使用外部文件系统来控制内部程序关闭</p><p>➢ MonitorStop</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URI</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span>Configuration</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token punctuation">{</span>FileSystem<span class="token punctuation">,</span> Path<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>StreamingContext<span class="token punctuation">,</span> StreamingContextState<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> MonitorStop<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span> <span class="token keyword">extends</span> Runnable <span class="token punctuation">{</span></span>
<span class="line">     <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">val</span> fs<span class="token operator">:</span> FileSystem <span class="token operator">=</span> FileSystem<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token keyword">new</span> URI<span class="token punctuation">(</span><span class="token string">&quot;hdfs://linux1:9000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">             <span class="token keyword">try</span></span>
<span class="line">             Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span></span>
<span class="line">             <span class="token keyword">catch</span> <span class="token punctuation">{</span></span>
<span class="line">                 <span class="token keyword">case</span> e<span class="token operator">:</span> InterruptedException <span class="token keyword">=&gt;</span></span>
<span class="line">                 e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">             <span class="token punctuation">}</span></span>
<span class="line">             <span class="token keyword">val</span> state<span class="token operator">:</span> StreamingContextState <span class="token operator">=</span> ssc<span class="token punctuation">.</span>getState</span>
<span class="line">             <span class="token keyword">val</span> bool<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> fs<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token keyword">new</span> Path<span class="token punctuation">(</span><span class="token string">&quot;hdfs://linux1:9000/stopSpark&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">             <span class="token keyword">if</span> <span class="token punctuation">(</span>bool<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                 <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> StreamingContextState<span class="token punctuation">.</span>ACTIVE<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                     ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span>stopSparkContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> stopGracefully <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">                     System<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                 <span class="token punctuation">}</span></span>
<span class="line">             <span class="token punctuation">}</span></span>
<span class="line">         <span class="token punctuation">}</span></span>
<span class="line">     <span class="token punctuation">}</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>➢ SparkTest</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> SparkTest <span class="token punctuation">{</span></span>
<span class="line">     <span class="token keyword">def</span> createSSC<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> _root_<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>StreamingContext <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">val</span> update<span class="token operator">:</span> <span class="token punctuation">(</span>Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> Some<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>values<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> status<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//当前批次内容的计算</span></span>
<span class="line">             <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> values<span class="token punctuation">.</span>sum</span>
<span class="line">             <span class="token comment">//取出状态信息中上一次状态</span></span>
<span class="line">             <span class="token keyword">val</span> lastStatu<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> status<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">             Some<span class="token punctuation">(</span>sum <span class="token operator">+</span> lastStatu<span class="token punctuation">)</span></span>
<span class="line">         <span class="token punctuation">}</span></span>
<span class="line">         <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[4]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;SparkTest&quot;</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token comment">//设置优雅的关闭</span></span>
<span class="line">        sparkConf<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">&quot;spark.streaming.stopGracefullyOnShutdown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">         ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;./ck&quot;</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">val</span> line<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;linux1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">val</span> word<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">val</span> wordAndOne<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> word<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">val</span> wordAndCount<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> wordAndOne<span class="token punctuation">.</span>pdateStateByKey<span class="token punctuation">(</span>update<span class="token punctuation">)</span></span>
<span class="line">         wordAndCount<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">         ssc</span>
<span class="line">     <span class="token punctuation">}</span></span>
<span class="line">     <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> StreamingContext<span class="token punctuation">.</span>getActiveOrCreate<span class="token punctuation">(</span><span class="token string">&quot;./ck&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> createSSC<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">new</span> Thread<span class="token punctuation">(</span><span class="token keyword">new</span> MonitorStop<span class="token punctuation">(</span>ssc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">         ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">     <span class="token punctuation">}</span> </span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="第-7-章-sparkstreaming-案例实操" tabindex="-1"><a class="header-anchor" href="#第-7-章-sparkstreaming-案例实操"><span>第 7 章 SparkStreaming 案例实操</span></a></h1><h2 id="_7-1-环境准备" tabindex="-1"><a class="header-anchor" href="#_7-1-环境准备"><span>7.1 环境准备</span></a></h2><h3 id="_7-1-1-pom-文件" tabindex="-1"><a class="header-anchor" href="#_7-1-1-pom-文件"><span>7.1.1 pom 文件</span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-core_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming-kafka-0-10_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.27<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-1-2-工具类" tabindex="-1"><a class="header-anchor" href="#_7-1-2-工具类"><span>7.1.2 工具类</span></a></h3><p>➢ PropertiesUtil</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>InputStreamReader</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</span>
<span class="line"><span class="token keyword">object</span> PropertiesUtil <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> load<span class="token punctuation">(</span>propertiesName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Properties <span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">val</span> prop<span class="token operator">=</span><span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        prop<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token keyword">new</span> InputStreamReader<span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getContextClassLoader<span class="token punctuation">.</span>getResourceAsStream<span class="token punctuation">(</span>propertiesName<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> prop</span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-2-实时数据生成模块" tabindex="-1"><a class="header-anchor" href="#_7-2-实时数据生成模块"><span>7.2 实时数据生成模块</span></a></h2><p>➢ config.properties</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties"><pre><code><span class="line"><span class="token comment">#jdbc 配置</span></span>
<span class="line"><span class="token key attr-name">jdbc.datasource.size</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"><span class="token key attr-name">jdbc.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://linux1:3306/spark2020?useUnicode=true&amp;characterEncoding=utf</span></span>
<span class="line"><span class="token key attr-name">8&amp;rewriteBatchedStatements</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">jdbc.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span></span>
<span class="line"><span class="token key attr-name">jdbc.password</span><span class="token punctuation">=</span><span class="token value attr-value">000000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Kafka 配置</p><blockquote><p>kafka.broker.list=linux1:9092,linux2:9092,linux3:9092</p></blockquote><p>➢ CityInfo</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token comment">/**</span>
<span class="line"> * 城市信息表</span>
<span class="line"> * @param city_id 城市 id</span>
<span class="line"> * @param city_name 城市名称</span>
<span class="line"> * @param area 城市所在大区</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">case</span> <span class="token keyword">class</span> CityInfo <span class="token punctuation">(</span>city_id<span class="token operator">:</span><span class="token builtin">Long</span><span class="token punctuation">,</span>city_name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>area<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>➢ RandomOptions</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ListBuffer</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Random</span>
<span class="line"><span class="token keyword">case</span> <span class="token keyword">class</span> RanOpt<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">,</span> weight<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">object</span> RandomOptions <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">def</span> apply<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>opts<span class="token operator">:</span> RanOpt<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">:</span> RandomOptions<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">val</span> randomOptions <span class="token operator">=</span> <span class="token keyword">new</span> RandomOptions<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span>opt <span class="token keyword">&lt;-</span> opts<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            randomOptions<span class="token punctuation">.</span>totalWeight <span class="token operator">+=</span> opt<span class="token punctuation">.</span>weight</span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token namespace">opt<span class="token punctuation">.</span>weight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                randomOptions<span class="token punctuation">.</span>optsBuffer <span class="token operator">+=</span> opt<span class="token punctuation">.</span>value</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        randomOptions</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> RandomOptions<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>opts<span class="token operator">:</span> RanOpt<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> totalWeight <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token keyword">var</span> optsBuffer <span class="token operator">=</span> <span class="token keyword">new</span> ListBuffer<span class="token punctuation">[</span>T<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">def</span> getRandomOpt<span class="token operator">:</span> T <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">val</span> randomNum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token keyword">new</span> Random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span>totalWeight<span class="token punctuation">)</span></span>
<span class="line">        optsBuffer<span class="token punctuation">(</span>randomNum<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>➢ MockerRealTime</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Properties<span class="token punctuation">,</span> Random<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>CityInfo</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token punctuation">{</span>PropertiesUtil<span class="token punctuation">,</span> RanOpt<span class="token punctuation">,</span> RandomOptions<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token punctuation">{</span>KafkaProducer<span class="token punctuation">,</span> ProducerConfig<span class="token punctuation">,</span> </span>
<span class="line">ProducerRecord<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer</span>
<span class="line"><span class="token keyword">object</span> MockerRealTime <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">/**</span>
<span class="line"></span>
<span class="line"> * 模拟的数据</span>
<span class="line">   *</span>
<span class="line"> * 格式 ：timestamp area city userid adid</span>
<span class="line"> * 某个时间点 某个地区 某个城市 某个用户 某个广告</span>
<span class="line">   */</span></span>
<span class="line">    <span class="token keyword">def</span> generateMockData<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">val</span> array<span class="token operator">:</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">val</span> CityRandomOpt <span class="token operator">=</span> RandomOptions<span class="token punctuation">(</span>RanOpt<span class="token punctuation">(</span>CityInfo<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;华北&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    RanOpt<span class="token punctuation">(</span>CityInfo<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;上海&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;华东&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    RanOpt<span class="token punctuation">(</span>CityInfo<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;广州&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;华南&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    RanOpt<span class="token punctuation">(</span>CityInfo<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;深圳&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;华南&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    RanOpt<span class="token punctuation">(</span>CityInfo<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;天津&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;华北&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">val</span> random <span class="token operator">=</span> <span class="token keyword">new</span> Random<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 模拟实时数据：</span></span>
<span class="line">    <span class="token comment">// timestamp province city userid adid</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> to <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">val</span> timestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">val</span> cityInfo<span class="token operator">:</span> CityInfo <span class="token operator">=</span> CityRandomOpt<span class="token punctuation">.</span>getRandomOpt</span>
<span class="line">    <span class="token keyword">val</span> city<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> cityInfo<span class="token punctuation">.</span>city_name</span>
<span class="line">    <span class="token keyword">val</span> area<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> cityInfo<span class="token punctuation">.</span>area</span>
<span class="line">    <span class="token keyword">val</span> adid<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">val</span> userid<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 拼接实时数据</span></span>
<span class="line">    array <span class="token operator">+=</span> timestamp <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> area <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> city <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> userid <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> adid</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    array<span class="token punctuation">.</span>toArray</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">def</span> createKafkaProducer<span class="token punctuation">(</span>broker<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建配置对象</span></span>
<span class="line">    <span class="token keyword">val</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 添加配置</span></span>
<span class="line">    prop<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ProducerConfig<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> broker<span class="token punctuation">)</span></span>
<span class="line">    prop<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ProducerConfig<span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> </span>
<span class="line">   <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    prop<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ProducerConfig<span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> </span>
<span class="line">   <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 根据配置创建 Kafka 生产者</span></span>
<span class="line">    <span class="token keyword">new</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"> <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">// 获取配置文件 config.properties 中的 Kafka 配置参数</span></span>
<span class="line"> <span class="token keyword">val</span> config<span class="token operator">:</span> Properties <span class="token operator">=</span> PropertiesUtil<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;config.properties&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">val</span> broker<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">&quot;kafka.broker.list&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">val</span> topic <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span></span>
<span class="line"> <span class="token comment">// 创建 Kafka 消费者</span></span>
<span class="line"> <span class="token keyword">val</span> kafkaProducer<span class="token operator">:</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> createKafkaProducer<span class="token punctuation">(</span>broker<span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">// 随机产生实时数据并通过 Kafka 生产者发送到 Kafka 集群中</span></span>
<span class="line"> <span class="token keyword">for</span> <span class="token punctuation">(</span>line <span class="token keyword">&lt;-</span> generateMockData<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> kafkaProducer<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token keyword">new</span> ProducerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> println<span class="token punctuation">(</span>line<span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-3-需求一-广告黑名单" tabindex="-1"><a class="header-anchor" href="#_7-3-需求一-广告黑名单"><span>7.3 需求一：广告黑名单</span></a></h2><p>实现实时的动态黑名单机制：将每天对某个广告点击超过 100 次的用户拉黑。 注：黑名单保存到 MySQL 中。</p><h3 id="_7-3-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_7-3-1-思路分析"><span>7.3.1 思路分析</span></a></h3><p>1）读取 Kafka 数据之后，并对 MySQL 中存储的黑名单数据做校验； 2）校验通过则对给用户点击广告次数累加一并存入 MySQL；</p><p>3）在存入 MySQL 之后对数据做校验，如果单日超过 100 次则将该用户加入黑名单。</p><h3 id="_7-3-2-mysql-建表" tabindex="-1"><a class="header-anchor" href="#_7-3-2-mysql-建表"><span>7.3.2 MySQL 建表</span></a></h3><p>创建库 spark2020 1）存放黑名单用户的表 CREATE TABLE black_list (userid CHAR(1) PRIMARY KEY); 2）存放单日各用户点击每个广告的次数 CREATE TABLE user_ad_count ( dt varchar(255), userid CHAR (1), adid CHAR (1), count BIGINT, PRIMARY KEY (dt, userid, adid) );</p><h3 id="_7-3-3-环境准备" tabindex="-1"><a class="header-anchor" href="#_7-3-3-环境准备"><span>7.3.3 环境准备</span></a></h3><p>接下来开始实时需求的分析，需要用到 SparkStreaming 来做实时数据的处理，在生产环境中，绝大部分时候都是对接的 Kafka 数据源，创建一个 SparkStreaming 读取 Kafka 数据的工具类。 ➢ MyKafkaUtil</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingContext</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>InputDStream</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ConsumerStrategies<span class="token punctuation">,</span> KafkaUtils<span class="token punctuation">,</span> </span>
<span class="line">LocationStrategies<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> MyKafkaUtil <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//1.创建配置信息对象</span></span>
<span class="line"> <span class="token keyword">private</span> <span class="token keyword">val</span> properties<span class="token operator">:</span> Properties <span class="token operator">=</span> PropertiesUtil<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;config.properties&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//2.用于初始化链接到集群的地址</span></span>
<span class="line"> <span class="token keyword">val</span> broker_list<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> properties<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">&quot;kafka.broker.list&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//3.kafka 消费者配置</span></span>
<span class="line"> <span class="token keyword">val</span> kafkaParam <span class="token operator">=</span> Map<span class="token punctuation">(</span></span>
<span class="line"> <span class="token string">&quot;bootstrap.servers&quot;</span> <span class="token operator">-&gt;</span> broker_list<span class="token punctuation">,</span></span>
<span class="line"> <span class="token string">&quot;key.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"> <span class="token string">&quot;value.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"> <span class="token comment">//消费者组</span></span>
<span class="line"> <span class="token string">&quot;group.id&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;commerce-consumer-group&quot;</span><span class="token punctuation">,</span></span>
<span class="line"> <span class="token comment">//如果没有初始化偏移量或者当前的偏移量不存在任何服务器上，可以使用这个配置属性</span></span>
<span class="line"> <span class="token comment">//可以使用这个配置，latest 自动重置偏移量为最新的偏移量</span></span>
<span class="line"> <span class="token string">&quot;auto.offset.reset&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span></span>
<span class="line"> <span class="token comment">//如果是 true，则这个消费者的偏移量会在后台自动提交,但是 kafka 宕机容易丢失数据</span></span>
<span class="line"> <span class="token comment">//如果是 false，会需要手动维护 kafka 偏移量</span></span>
<span class="line"> <span class="token string">&quot;enable.auto.commit&quot;</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">// 创建 DStream，返回接收到的输入数据</span></span>
<span class="line"> <span class="token comment">// LocationStrategies：根据给定的主题和集群地址创建 consumer</span></span>
<span class="line"> <span class="token comment">// LocationStrategies.PreferConsistent：持续的在所有 Executor 之间分配分区</span></span>
<span class="line"> <span class="token comment">// ConsumerStrategies：选择如何在 Driver 和 Executor 上创建和配置 Kafka Consumer</span></span>
<span class="line"> <span class="token comment">// ConsumerStrategies.Subscribe：订阅一系列主题</span></span>
<span class="line"> <span class="token keyword">def</span> getKafkaStream<span class="token punctuation">(</span>topic<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span><span class="token operator">:</span> </span>
<span class="line">InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">val</span> dStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span> </span>
<span class="line">LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span> ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> </span>
<span class="line"><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParam<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> dStream</span>
<span class="line"> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>➢ JdbcUtil</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Connection<span class="token punctuation">,</span> PreparedStatement<span class="token punctuation">,</span> ResultSet<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DataSource</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>pool<span class="token punctuation">.</span></span>DruidDataSourceFactory</span>
<span class="line"> <span class="token keyword">object</span> JdbcUtil <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//初始化连接池</span></span>
<span class="line"> <span class="token keyword">var</span> dataSource<span class="token operator">:</span> DataSource <span class="token operator">=</span> init<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//初始化连接池方法</span></span>
<span class="line"> <span class="token keyword">def</span> init<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> DataSource <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">val</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">val</span> config<span class="token operator">:</span> Properties <span class="token operator">=</span> PropertiesUtil<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;config.properties&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;driverClassName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;com.mysql.jdbc.Driver&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">&quot;jdbc.url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">&quot;jdbc.user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">&quot;jdbc.password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;maxActive&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">config<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">&quot;jdbc.datasource.size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> DruidDataSourceFactory<span class="token punctuation">.</span>createDataSource<span class="token punctuation">(</span>properties<span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token comment">//获取 MySQL 连接</span></span>
<span class="line"> <span class="token keyword">def</span> getConnection<span class="token operator">:</span> Connection <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> dataSource<span class="token punctuation">.</span>getConnection</span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token comment">//执行 SQL 语句,单条数据插入</span></span>
<span class="line"> <span class="token keyword">def</span> executeUpdate<span class="token punctuation">(</span>connection<span class="token operator">:</span> Connection<span class="token punctuation">,</span> sql<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> params<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> </span>
<span class="line"><span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">var</span> rtn <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"> <span class="token keyword">var</span> pstmt<span class="token operator">:</span> PreparedStatement <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"> <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line"> connection<span class="token punctuation">.</span>setAutoCommit<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line"> pstmt <span class="token operator">=</span> connection<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span>sql<span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> params<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>setObject<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> params<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> rtn <span class="token operator">=</span> pstmt<span class="token punctuation">.</span>executeUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> connection<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> rtn</span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token comment">//执行 SQL 语句,批量数据插入</span></span>
<span class="line"> <span class="token keyword">def</span> executeBatchUpdate<span class="token punctuation">(</span>connection<span class="token operator">:</span> Connection<span class="token punctuation">,</span> sql<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> paramsList<span class="token operator">:</span> </span>
<span class="line">Iterable<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">var</span> rtn<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"> <span class="token keyword">var</span> pstmt<span class="token operator">:</span> PreparedStatement <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"> <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line"> connection<span class="token punctuation">.</span>setAutoCommit<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line"> pstmt <span class="token operator">=</span> connection<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span>sql<span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">for</span> <span class="token punctuation">(</span>params <span class="token keyword">&lt;-</span> paramsList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> params<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>setObject<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> params<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>addBatch<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> rtn <span class="token operator">=</span> pstmt<span class="token punctuation">.</span>executeBatch<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> connection<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> rtn</span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token comment">//判断一条数据是否存在</span></span>
<span class="line"> <span class="token keyword">def</span> isExist<span class="token punctuation">(</span>connection<span class="token operator">:</span> Connection<span class="token punctuation">,</span> sql<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> params<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> </span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">var</span> flag<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="line"> <span class="token keyword">var</span> pstmt<span class="token operator">:</span> PreparedStatement <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"> <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line"> pstmt <span class="token operator">=</span> connection<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span>sql<span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> params<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>setObject<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> params<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> flag <span class="token operator">=</span> pstmt<span class="token punctuation">.</span>executeQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> flag</span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token comment">//获取 MySQL 的一条数据</span></span>
<span class="line"> <span class="token keyword">def</span> getDataFromMysql<span class="token punctuation">(</span>connection<span class="token operator">:</span> Connection<span class="token punctuation">,</span> sql<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> params<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> </span>
<span class="line"><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">var</span> result<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0L</span></span>
<span class="line"> <span class="token keyword">var</span> pstmt<span class="token operator">:</span> PreparedStatement <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"> <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line"> pstmt <span class="token operator">=</span> connection<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span>sql<span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> params<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>setObject<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> params<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token keyword">val</span> resultSet<span class="token operator">:</span> ResultSet <span class="token operator">=</span> pstmt<span class="token punctuation">.</span>executeQuery<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> result <span class="token operator">=</span> resultSet<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> resultSet<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> pstmt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> result</span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token comment">//主方法,用于测试上述方法</span></span>
<span class="line"> <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-4-代码实现" tabindex="-1"><a class="header-anchor" href="#_7-3-4-代码实现"><span>7.3.4 代码实现</span></a></h3><p>➢ Ads_log case class Ads_log(timestamp: Long, area: String, city: String, userid: String, adid: String)</p><p>➢ BlackListHandler</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Connection</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>SimpleDateFormat</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>Ads_log</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span>JdbcUtil</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</span>
<span class="line"><span class="token keyword">object</span> BlackListHandler <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//时间格式化对象</span></span>
<span class="line"> <span class="token keyword">private</span> <span class="token keyword">val</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">def</span> addBlackList<span class="token punctuation">(</span>filterAdsLogDSteam<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//统计当前批次中单日每个用户点击每个广告的总次数</span></span>
<span class="line"> <span class="token comment">//1.将数据接转换结构 ads_log=&gt;((date,user,adid),1)</span></span>
<span class="line"> <span class="token keyword">val</span> dateUserAdToOne<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">filterAdsLogDSteam<span class="token punctuation">.</span>map<span class="token punctuation">(</span>adsLog <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//a.将时间戳转换为日期字符串</span></span>
<span class="line"> <span class="token keyword">val</span> date<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> sdf<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">(</span>adsLog<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//b.返回值</span></span>
<span class="line"> <span class="token punctuation">(</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span> adsLog<span class="token punctuation">.</span>userid<span class="token punctuation">,</span> adsLog<span class="token punctuation">.</span>adid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//2.统计单日每个用户点击每个广告的总次数</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span>user<span class="token punctuation">,</span>adid<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">=&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span>user<span class="token punctuation">,</span>adid<span class="token punctuation">)</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">val</span> dateUserAdToCount<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">dateUserAdToOne<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line"> dateUserAdToCount<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> rdd<span class="token punctuation">.</span>foreachPartition<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">val</span> connection<span class="token operator">:</span> Connection <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>getConnection</span>
<span class="line"> iter<span class="token punctuation">.</span>foreach <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> user<span class="token punctuation">,</span> ad<span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span></span>
<span class="line"> JdbcUtil<span class="token punctuation">.</span>executeUpdate<span class="token punctuation">(</span>connection<span class="token punctuation">,</span></span>
<span class="line"> <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line"> |INSERT INTO user_ad_count (dt,userid,adid,count)</span>
<span class="line"> |VALUES (?,?,?,?)</span>
<span class="line"> |ON DUPLICATE KEY</span>
<span class="line"> |UPDATE count=count+?</span>
<span class="line"> &quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">,</span> Array<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> user<span class="token punctuation">,</span> ad<span class="token punctuation">,</span> count<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">val</span> ct<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>getDataFromMysql<span class="token punctuation">(</span>connection<span class="token punctuation">,</span> &quot;select count from </span>
<span class="line">user_ad_count where dt<span class="token operator">=</span><span class="token operator">?</span> and userid<span class="token operator">=</span><span class="token operator">?</span> and adid <span class="token operator">=</span><span class="token operator">?</span>&quot;<span class="token punctuation">,</span> Array<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> user<span class="token punctuation">,</span> ad<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">if</span> <span class="token punctuation">(</span>ct <span class="token operator">&gt;=</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"> JdbcUtil<span class="token punctuation">.</span>executeUpdate<span class="token punctuation">(</span>connection<span class="token punctuation">,</span> &quot;INSERT INTO black_list <span class="token punctuation">(</span>userid<span class="token punctuation">)</span> </span>
<span class="line">VALUES <span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">)</span> ON DUPLICATE KEY update userid<span class="token operator">=</span><span class="token operator">?</span>&quot;<span class="token punctuation">,</span> Array<span class="token punctuation">(</span>user<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"> <span class="token keyword">def</span> filterByBlackList<span class="token punctuation">(</span>adsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> adsLogDStream<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> rdd<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>adsLog <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">val</span> connection<span class="token operator">:</span> Connection <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>getConnection</span>
<span class="line"> <span class="token keyword">val</span> bool<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>isExist<span class="token punctuation">(</span>connection<span class="token punctuation">,</span> &quot;select <span class="token operator">*</span> from black_list </span>
<span class="line">where userid<span class="token operator">=</span><span class="token operator">?</span>&quot;<span class="token punctuation">,</span> Array<span class="token punctuation">(</span>adsLog<span class="token punctuation">.</span>userid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token operator">!</span>bool</span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>➢ RealtimeApp</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>Ads_log</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span>BlackListHandler</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span>MyKafkaUtil</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> RealTimeApp <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//1.创建 SparkConf</span></span>
<span class="line"> <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span>&quot;RealTimeApp </span>
<span class="line"><span class="token string">&quot;).setMaster(&quot;</span>local<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>&quot;<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//2.创建 StreamingContext</span></span>
<span class="line"> <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//3.读取数据</span></span>
<span class="line"> <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span><span class="token string">&quot;ads_log&quot;</span><span class="token punctuation">,</span> ssc<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//4.将从 Kafka 读出的数据转换为样例类对象</span></span>
<span class="line"> <span class="token keyword">val</span> adsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span> <span class="token operator">=</span> kafkaDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span></span>
<span class="line"> Ads_log<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//5.需求一：根据 MySQL 中的黑名单过滤当前数据集</span></span>
<span class="line"> <span class="token keyword">val</span> filterAdsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">BlackListHandler2<span class="token punctuation">.</span>filterByBlackList<span class="token punctuation">(</span>adsLogDStream<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//6.需求一：将满足要求的用户写入黑名单</span></span>
<span class="line"> BlackListHandler2<span class="token punctuation">.</span>addBlackList<span class="token punctuation">(</span>filterAdsLogDStream<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//测试打印</span></span>
<span class="line"> filterAdsLogDStream<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> filterAdsLogDStream<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//启动任务</span></span>
<span class="line"> ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-4-需求二-广告点击量实时统计" tabindex="-1"><a class="header-anchor" href="#_7-4-需求二-广告点击量实时统计"><span>7.4 需求二：广告点击量实时统计</span></a></h2><p>描述：实时统计每天各地区各城市各广告的点击总流量，并将其存入 MySQL。</p><h3 id="_7-4-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_7-4-1-思路分析"><span>7.4.1 思路分析</span></a></h3><p>1）单个批次内对数据进行按照天维度的聚合统计;</p><p>2）结合 MySQL 数据跟当前批次数据更新原有的数据。</p><h3 id="_7-4-2-mysql-建表" tabindex="-1"><a class="header-anchor" href="#_7-4-2-mysql-建表"><span>7.4.2 MySQL 建表</span></a></h3><p>CREATE TABLE area_city_ad_count ( dt VARCHAR(255), area VARCHAR(255), city VARCHAR(255), adid VARCHAR(255), count BIGINT, PRIMARY KEY (dt,area,city,adid) );</p><h3 id="_7-4-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_7-4-3-代码实现"><span>7.4.3 代码实现</span></a></h3><p>➢ DateAreaCityAdCountHandler</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Connection</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>SimpleDateFormat</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>Ads_log</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span>JdbcUtil</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</span>
<span class="line"><span class="token keyword">object</span> DateAreaCityAdCountHandler <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//时间格式化对象</span></span>
<span class="line"> <span class="token keyword">private</span> <span class="token keyword">val</span> sdf<span class="token operator">:</span> SimpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">/**</span>
<span class="line"></span>
<span class="line"> * 统计每天各大区各个城市广告点击总数并保存至 MySQL 中</span>
<span class="line">   *</span>
<span class="line"> * @param filterAdsLogDStream 根据黑名单过滤后的数据集</span>
<span class="line">   */</span></span>
<span class="line">    <span class="token keyword">def</span> saveDateAreaCityAdCountToMysql<span class="token punctuation">(</span>filterAdsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> </span>
<span class="line">   <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//1.统计每天各大区各个城市广告点击总数</span></span>
<span class="line">    <span class="token keyword">val</span> dateAreaCityAdToCount<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">   filterAdsLogDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>ads_log <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//a.取出时间戳</span></span>
<span class="line">    <span class="token keyword">val</span> timestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> ads_log<span class="token punctuation">.</span>timestamp</span>
<span class="line">    <span class="token comment">//b.格式化为日期字符串</span></span>
<span class="line">    <span class="token keyword">val</span> dt<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> sdf<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//c.组合,返回</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> ads_log<span class="token punctuation">.</span>area<span class="token punctuation">,</span> ads_log<span class="token punctuation">.</span>city<span class="token punctuation">,</span> ads_log<span class="token punctuation">.</span>adid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//2.将单个批次统计之后的数据集合 MySQL 数据对原有的数据更新</span></span>
<span class="line">    dateAreaCityAdToCount<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//对每个分区单独处理</span></span>
<span class="line">    rdd<span class="token punctuation">.</span>foreachPartition<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//a.获取连接</span></span>
<span class="line">    <span class="token keyword">val</span> connection<span class="token operator">:</span> Connection <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>getConnection</span>
<span class="line">    <span class="token comment">//b.写库</span></span>
<span class="line">    iter<span class="token punctuation">.</span>foreach <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> area<span class="token punctuation">,</span> city<span class="token punctuation">,</span> adid<span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span></span>
<span class="line">    JdbcUtil<span class="token punctuation">.</span>executeUpdate<span class="token punctuation">(</span>connection<span class="token punctuation">,</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">    |INSERT INTO area_city_ad_count (dt,area,city,adid,count)</span>
<span class="line">    |VALUES(?,?,?,?,?)</span>
<span class="line">    |ON DUPLICATE KEY</span>
<span class="line">    |UPDATE count=count+?;</span>
<span class="line">    &quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">,</span></span>
<span class="line">    Array<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> area<span class="token punctuation">,</span> city<span class="token punctuation">,</span> adid<span class="token punctuation">,</span> count<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//c.释放连接</span></span>
<span class="line">    connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>➢ RealTimeApp</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Connection</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>Ads_log</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token punctuation">{</span>BlackListHandler<span class="token punctuation">,</span> DateAreaCityAdCountHandler<span class="token punctuation">,</span> </span>
<span class="line">LastHourAdCountHandler<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token punctuation">{</span>JdbcUtil<span class="token punctuation">,</span> MyKafkaUtil<span class="token punctuation">,</span> PropertiesUtil<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> RealTimeApp <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//1.创建 SparkConf</span></span>
<span class="line"> <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> </span>
<span class="line">SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;RealTimeApp&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//2.创建 StreamingContext</span></span>
<span class="line"> <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//3.读取 Kafka 数据 1583288137305 华南 深圳 4 3</span></span>
<span class="line"> <span class="token keyword">val</span> topic<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> </span>
<span class="line">PropertiesUtil<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;config.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">&quot;kafka.topic&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>topic<span class="token punctuation">,</span> ssc<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//4.将每一行数据转换为样例类对象</span></span>
<span class="line"> <span class="token keyword">val</span> adsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span> <span class="token operator">=</span> kafkaDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//a.取出 value 并按照&quot; &quot;切分</span></span>
<span class="line"> <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//b.封装为样例类对象</span></span>
<span class="line"> Ads_log<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//5.根据 MySQL 中的黑名单表进行数据过滤</span></span>
<span class="line"> <span class="token keyword">val</span> filterAdsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span> <span class="token operator">=</span> adsLogDStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>adsLog <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//查询 MySQL,查看当前用户是否存在。</span></span>
<span class="line"> <span class="token keyword">val</span> connection<span class="token operator">:</span> Connection <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>getConnection</span>
<span class="line"> <span class="token keyword">val</span> bool<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>isExist<span class="token punctuation">(</span>connection<span class="token punctuation">,</span> &quot;select <span class="token operator">*</span> from black_list </span>
<span class="line">where userid<span class="token operator">=</span><span class="token operator">?</span>&quot;<span class="token punctuation">,</span> Array<span class="token punctuation">(</span>adsLog<span class="token punctuation">.</span>userid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token operator">!</span>bool</span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> filterAdsLogDStream<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//6.对没有被加入黑名单的用户统计当前批次单日各个用户对各个广告点击的总次数,</span></span>
<span class="line"> <span class="token comment">// 并更新至 MySQL</span></span>
<span class="line"> <span class="token comment">// 之后查询更新之后的数据,判断是否超过 100 次。</span></span>
<span class="line"> <span class="token comment">// 如果超过则将给用户加入黑名单</span></span>
<span class="line"> BlackListHandler<span class="token punctuation">.</span>saveBlackListToMysql<span class="token punctuation">(</span>filterAdsLogDStream<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//7.统计每天各大区各个城市广告点击总数并保存至 MySQL 中</span></span>
<span class="line">dateAreaCityAdCountHandler<span class="token punctuation">.</span>saveDateAreaCityAdCountToMysql<span class="token punctuation">(</span>filterAdsLogDStream<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//10.开启任务</span></span>
<span class="line"> ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-5-需求三-最近一小时广告点击量" tabindex="-1"><a class="header-anchor" href="#_7-5-需求三-最近一小时广告点击量"><span>7.5 需求三：最近一小时广告点击量</span></a></h2><p>结果展示： 1：List [15:50-&gt;10,15:51-&gt;25,15:52-&gt;30] 2：List [15:50-&gt;10,15:51-&gt;25,15:52-&gt;30] 3：List [15:50-&gt;10,15:51-&gt;25,15:52-&gt;30]</p><h3 id="_7-5-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_7-5-1-思路分析"><span>7.5.1 思路分析</span></a></h3><p>1）开窗确定时间范围； 2）在窗口内将数据转换数据结构为((adid,hm),count); 3）按照广告 id 进行分组处理，组内按照时分排序。</p><h3 id="_7-5-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_7-5-2-代码实现"><span>7.5.2 代码实现</span></a></h3><p>➢ LastHourAdCountHandler</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>SimpleDateFormat</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>Ads_log</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>Minutes</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream</span>
<span class="line"><span class="token keyword">object</span> LastHourAdCountHandler <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line"> <span class="token comment">//时间格式化对象</span></span>
<span class="line"> <span class="token keyword">private</span> <span class="token keyword">val</span> sdf<span class="token operator">:</span> SimpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> SimpleDateFormat<span class="token punctuation">(</span><span class="token string">&quot;HH:mm&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">/**</span>
<span class="line"></span>
<span class="line"> * 统计最近一小时(2 分钟)广告分时点击总数</span>
<span class="line">   *</span>
<span class="line"> * @param filterAdsLogDStream 过滤后的数据集</span>
<span class="line"> * @return</span>
<span class="line">   */</span></span>
<span class="line">    <span class="token keyword">def</span> getAdHourMintToCount<span class="token punctuation">(</span>filterAdsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> </span>
<span class="line">   DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//1.开窗 =&gt; 时间间隔为 1 个小时 window()</span></span>
<span class="line">    <span class="token keyword">val</span> windowAdsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">   filterAdsLogDStream<span class="token punctuation">.</span>window<span class="token punctuation">(</span>Minutes<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//2.转换数据结构 ads_log =&gt;((adid,hm),1L) map()</span></span>
<span class="line">    <span class="token keyword">val</span> adHmToOneDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">   windowAdsLogDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>adsLog <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">val</span> timestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> adsLog<span class="token punctuation">.</span>timestamp</span>
<span class="line">    <span class="token keyword">val</span> hm<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> sdf<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token punctuation">(</span>adsLog<span class="token punctuation">.</span>adid<span class="token punctuation">,</span> hm<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//3.统计总数 ((adid,hm),1L)=&gt;((adid,hm),sum) reduceBykey(_+_)</span></span>
<span class="line">    <span class="token keyword">val</span> adHmToCountDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">   adHmToOneDStream<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//4.转换数据结构 ((adid,hm),sum)=&gt;(adid,(hm,sum)) map()</span></span>
<span class="line">    <span class="token keyword">val</span> adToHmCountDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">   adHmToCountDStream<span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>adid<span class="token punctuation">,</span> hm<span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span></span>
<span class="line">    <span class="token punctuation">(</span>adid<span class="token punctuation">,</span> <span class="token punctuation">(</span>hm<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//5.按照 adid 分组 (adid,(hm,sum))=&gt;(adid,Iter[(hm,sum),...]) groupByKey</span></span>
<span class="line">    adToHmCountDStream<span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span></span>
<span class="line">    iter<span class="token punctuation">.</span>toList<span class="token punctuation">.</span>sortWith<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1 <span class="token operator">&lt;</span> _<span class="token punctuation">.</span>_1<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>➢ RealTimeApp</p><div class="language-scala line-numbers-mode" data-highlighter="prismjs" data-ext="scala"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Connection</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>Ads_log</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token punctuation">{</span>BlackListHandler<span class="token punctuation">,</span> DateAreaCityAdCountHandler<span class="token punctuation">,</span> </span>
<span class="line">LastHourAdCountHandler<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token punctuation">{</span>JdbcUtil<span class="token punctuation">,</span> MyKafkaUtil<span class="token punctuation">,</span> PropertiesUtil<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf</span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">object</span> RealTimeApp <span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line"> <span class="token comment">//1.创建 SparkConf</span></span>
<span class="line"> <span class="token keyword">val</span> sparkConf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> </span>
<span class="line">SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;RealTimeApp&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//2.创建 StreamingContext</span></span>
<span class="line"> <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//3.读取 Kafka 数据 1583288137305 华南 深圳 4 3</span></span>
<span class="line"> <span class="token keyword">val</span> topic<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> </span>
<span class="line">PropertiesUtil<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;config.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">&quot;kafka.topic&quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token keyword">val</span> kafkaDStream<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">MyKafkaUtil<span class="token punctuation">.</span>getKafkaStream<span class="token punctuation">(</span>topic<span class="token punctuation">,</span> ssc<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//4.将每一行数据转换为样例类对象</span></span>
<span class="line"> <span class="token keyword">val</span> adsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span> <span class="token operator">=</span> kafkaDStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//a.取出 value 并按照&quot; &quot;切分</span></span>
<span class="line"> <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//b.封装为样例类对象</span></span>
<span class="line"> Ads_log<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//5.根据 MySQL 中的黑名单表进行数据过滤</span></span>
<span class="line"> <span class="token keyword">val</span> filterAdsLogDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span>Ads_log<span class="token punctuation">]</span> <span class="token operator">=</span> adsLogDStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>adsLog <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"> <span class="token comment">//查询 MySQL,查看当前用户是否存在。</span></span>
<span class="line"> <span class="token keyword">val</span> connection<span class="token operator">:</span> Connection <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>getConnection</span>
<span class="line"> <span class="token keyword">val</span> bool<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> JdbcUtil<span class="token punctuation">.</span>isExist<span class="token punctuation">(</span>connection<span class="token punctuation">,</span> &quot;select <span class="token operator">*</span> from black_list </span>
<span class="line">where userid<span class="token operator">=</span><span class="token operator">?</span>&quot;<span class="token punctuation">,</span> Array<span class="token punctuation">(</span>adsLog<span class="token punctuation">.</span>userid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"> connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token operator">!</span>bool</span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"> filterAdsLogDStream<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//6.对没有被加入黑名单的用户统计当前批次单日各个用户对各个广告点击的总次数,</span></span>
<span class="line"> <span class="token comment">// 并更新至 MySQL</span></span>
<span class="line"> <span class="token comment">// 之后查询更新之后的数据,判断是否超过 100 次。</span></span>
<span class="line"> <span class="token comment">// 如果超过则将给用户加入黑名单</span></span>
<span class="line"> BlackListHandler<span class="token punctuation">.</span>saveBlackListToMysql<span class="token punctuation">(</span>filterAdsLogDStream<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//7.统计每天各大区各个城市广告点击总数并保存至 MySQL 中</span></span>
<span class="line"> DateAreaCityAdCountHandler<span class="token punctuation">.</span>saveDateAreaCityAdCountToMysql<span class="token punctuation">(</span>filterAdsLogDStream<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//8.统计最近一小时(2 分钟)广告分时点击总数</span></span>
<span class="line"> <span class="token keyword">val</span> adToHmCountListDStream<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> </span>
<span class="line">LastHourAdCountHandler<span class="token punctuation">.</span>getAdHourMintToCount<span class="token punctuation">(</span>filterAdsLogDStream<span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//9.打印</span></span>
<span class="line"> adToHmCountListDStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token comment">//10.开启任务</span></span>
<span class="line"> ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新：: </span><time class="meta-item-info" datetime="2025-04-19T17:54:57.000Z" data-allow-mismatch>2025/4/19 17:54</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 921757697@qq.com">alice</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/simple-doc/assets/app-DzmgiGLk.js" defer></script>
  </body>
</html>
