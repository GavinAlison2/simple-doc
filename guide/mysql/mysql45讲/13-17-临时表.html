<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/simple-doc/images/favicon.ico"><title>13-17 | Blog</title><meta name="description" content="个人博客">
    <link rel="preload" href="/simple-doc/assets/style-B3-VMakp.css" as="style"><link rel="stylesheet" href="/simple-doc/assets/style-B3-VMakp.css">
    <link rel="modulepreload" href="/simple-doc/assets/app-DzmgiGLk.js"><link rel="modulepreload" href="/simple-doc/assets/13-17-临时表.html-BQsnUS-M.js">
    <link rel="prefetch" href="/simple-doc/assets/index.html-CoRS7up-.js" as="script"><link rel="prefetch" href="/simple-doc/assets/bak-README.html-By5_RZXG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/get-started.html-CX2qJGDP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/etl-resume.html-xtgXy6z6.js" as="script"><link rel="prefetch" href="/simple-doc/assets/java-resume.html-MbjdglIm.js" as="script"><link rel="prefetch" href="/simple-doc/assets/web3-resume.html-CikP1eyy.js" as="script"><link rel="prefetch" href="/simple-doc/assets/小程序.html-CDlbppON.js" as="script"><link rel="prefetch" href="/simple-doc/assets/时间规划.html-BzeHPhhR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/自媒体.html-Cd51wR84.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-JVM什么样的对象直接进入老年代.html-BgGtMJfm.js" as="script"><link rel="prefetch" href="/simple-doc/assets/2-JVM双亲委派机制.html-EJgrsmjs.js" as="script"><link rel="prefetch" href="/simple-doc/assets/3-JVM内存分布.html-BNCPBUEF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/4-JVM内存分配.html-fuLBw3Qt.js" as="script"><link rel="prefetch" href="/simple-doc/assets/5-gc.html-BI2-qePY.js" as="script"><link rel="prefetch" href="/simple-doc/assets/6-解析Class文件.html-B0pdOeBg.js" as="script"><link rel="prefetch" href="/simple-doc/assets/7-cmsGC的工作原理和致命缺陷.html-CKme9mJJ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/8-g1.html-CFg_ulNq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-a7bADKk7.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-批量导入死锁问题.html-CFzLBwM-.js" as="script"><link rel="prefetch" href="/simple-doc/assets/如何排查问题cpu100_.html-BKkcpYrF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/react-readme.html-BExZaYZc.js" as="script"><link rel="prefetch" href="/simple-doc/assets/react-simple.html-DPBznu7L.js" as="script"><link rel="prefetch" href="/simple-doc/assets/react1-do.html-jiGx_V6Y.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BDXEyqA_.js" as="script"><link rel="prefetch" href="/simple-doc/assets/min-project.html-CuU9qQvE.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html--77HvGhr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/ts-decorator.html-DkpslRnk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/ts-quick-start.html-Cbp6FnOa.js" as="script"><link rel="prefetch" href="/simple-doc/assets/ts-readme-viavideo.html-Y8GJV3vk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/typescript-readme.html-DyNtQ7Ji.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1.html-Bfd5rOdV.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-数据仓库工具箱-笔记.html-C8pQnBFr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/2-数据产品经理的工作笔记.html-BM9xLdrs.js" as="script"><link rel="prefetch" href="/simple-doc/assets/3-数据产品经理实战笔记.html-C_1_g8pR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BOqGVW8u.js" as="script"><link rel="prefetch" href="/simple-doc/assets/产品经理岗位分析.html-Dbf3e_fP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/后端开发.html-BlQJsHwK.js" as="script"><link rel="prefetch" href="/simple-doc/assets/001-let-var-const.html-CyrPBvrI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/002-let.html-BRY54MvC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/003-constructor.html-Bf56WLlT.js" as="script"><link rel="prefetch" href="/simple-doc/assets/004-rest-arg.html-C93Fbzea.js" as="script"><link rel="prefetch" href="/simple-doc/assets/005-extend-expression.html-CidDhcRf.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-关键词.html-Zd6Hztyi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/array.html-D_StCr91.js" as="script"><link rel="prefetch" href="/simple-doc/assets/async-await.html-FZal8qrj.js" as="script"><link rel="prefetch" href="/simple-doc/assets/closure.html-CnkoR_MC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/fun.html-D1YSgeV5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/promise.html-JIYwOKe8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-Bxa3QD7u.js" as="script"><link rel="prefetch" href="/simple-doc/assets/regex.html-Cq95gnhA.js" as="script"><link rel="prefetch" href="/simple-doc/assets/string.html-C763CaSa.js" as="script"><link rel="prefetch" href="/simple-doc/assets/高阶函数.html-DtFc5y2Z.js" as="script"><link rel="prefetch" href="/simple-doc/assets/bigdata-readme.html-C9tbAaC5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/dataworks.html-AGaxHToz.js" as="script"><link rel="prefetch" href="/simple-doc/assets/hive-start.html-DErgC9Uz.js" as="script"><link rel="prefetch" href="/simple-doc/assets/notice.html-DwYexM_y.js" as="script"><link rel="prefetch" href="/simple-doc/assets/resume.html-CJ0v7MKB.js" as="script"><link rel="prefetch" href="/simple-doc/assets/todo.html-BYiqLhN4.js" as="script"><link rel="prefetch" href="/simple-doc/assets/元数据管理.html-rd11M2pk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/工作流集成方案.html-DVxD1moW.js" as="script"><link rel="prefetch" href="/simple-doc/assets/数据开发.html-BHhhOvRi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/数据计算方案.html-BdPwXoYZ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/数据集成方案.html-Dub5FWqW.js" as="script"><link rel="prefetch" href="/simple-doc/assets/调度方案.html-wwwJHfKQ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-DjrpPfMq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/BlockingQueue.html-C7aU4SFG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/DeplayQueue.html-DFGB3v0a.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-fPZNLzuq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/手写线程池-思路.html-Crfr-BY5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/手写线程池.html-DWuOOXud.js" as="script"><link rel="prefetch" href="/simple-doc/assets/线程池监控2.html-GFkGF7_u.js" as="script"><link rel="prefetch" href="/simple-doc/assets/设计线程池监控.html-B2iAESuC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mmap.html-DJLTpHeR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-DE9xkrYq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/same.html-CEVSt6Al.js" as="script"><link rel="prefetch" href="/simple-doc/assets/innoDB.html-BxfdjbYx.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mvcc.html-awcIi7mS.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-45讲.html-J8oZoOv5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-Doublewrite.html-9K1Cy40j.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-b_tree-插入与页分裂.html-Bz9M-fdN.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-basic.html-C2jwPoO_.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-binlog-redolog.html-DtlSWdQe.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-buffer-pool.html-p7ONxKPQ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-bufferpool-freeflushlru.html-BBjxBLV6.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-changebuffer.html-BMFUJa_d.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-explained.html-4ad7y947.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-join.html-DSikhHZ0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-log.html-pP0NETGY.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-log对应事务.html-daqg076M.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-rbo-cbo.html-BuyVR0Aq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-sql卡住.html-D12Jodk9.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-内存自适应哈希索引.html-B2UXHC7G.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-思考整理.html-nUai5VJd.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-执行逻辑.html-COOagx0T.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-索引.html-DGeZYjJ3.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-索引失效.html-CwFYMKUi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-锁.html-BdbdhRLi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-面试题.html-JrN6b6vI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BnhbtjI-.js" as="script"><link rel="prefetch" href="/simple-doc/assets/todo.html-BFwUCOVI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/手写MySQL.html-CFWCi0iG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/反欺诈系统.html-hGJexD9t.js" as="script"><link rel="prefetch" href="/simple-doc/assets/urule.html-sGssCq0Q.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BALdRDon.js" as="script"><link rel="prefetch" href="/simple-doc/assets/tailwind-install.html-DRbPVQ9S.js" as="script"><link rel="prefetch" href="/simple-doc/assets/tailwind-official.html-aMZX-4B8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/tailwind-readme.html-CkcRcJZ5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/tailwind-todo.html-D2h1NVhz.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BPJO8Fy6.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-01.html-XvLb8dtQ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-02.html-DwcsPKT8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-basic-api.html-CUPGiR_l.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-component.html-CotAnxHn.js" as="script"><link rel="prefetch" href="/simple-doc/assets/uniapp-deploy.html-DIPCfKFq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-LnUp5gWY.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test1.html-BI0B1Wcw.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test2.html-Br72TJbh.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test3.html-B6xlbOwB.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue-cli-command.html-fmYXaVG_.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue-cli.html-BeYWEQYC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue-crud.html-CYCr0s4B.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue-router.html-DB0Rr5ag.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue2-api.html-BS-ZbA4x.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue2-directive.html-CYp7-RH0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue2-ops.html-0n4b9IKr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue2.html-KWcI8_Di.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue3-api.html-_foiEeyL.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue3-component.html-Bb8PkRlM.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vue3.html-CfJtZqbU.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vuex.html-jOJ0aMc3.js" as="script"><link rel="prefetch" href="/simple-doc/assets/resume.html-u36y829W.js" as="script"><link rel="prefetch" href="/simple-doc/assets/worker.html-CBwW3m19.js" as="script"><link rel="prefetch" href="/simple-doc/assets/some.html-BwXdzUN2.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test1.html-Da4_Zfx7.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test3.html-OLJbkEAH.js" as="script"><link rel="prefetch" href="/simple-doc/assets/test4.html-D1RWEP5q.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vuepress-install.html-CmLdYaeX.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-CjhIQ0dl.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-C66V0ouZ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-C221oZ0f.js" as="script"><link rel="prefetch" href="/simple-doc/assets/总结.html-HTDJYTyx.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-i64IKQ3G.js" as="script"><link rel="prefetch" href="/simple-doc/assets/vote-do.html-DSDnqVLK.js" as="script"><link rel="prefetch" href="/simple-doc/assets/docker-compose搭建环境.html-DQOqdmM5.js" as="script"><link rel="prefetch" href="/simple-doc/assets/docker.html-B5mkBOkp.js" as="script"><link rel="prefetch" href="/simple-doc/assets/docker01.html-BEIml5Rx.js" as="script"><link rel="prefetch" href="/simple-doc/assets/data-integration.html-BXQnThwv.js" as="script"><link rel="prefetch" href="/simple-doc/assets/case1-购房群体.html-ztmUt6Lf.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter1-hadoop-hdfs.html-BvBqhSm0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter2-hadoop-yarn.html-CpeRKAq8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter3-hadoop-install-for-window.html-DC_BBhD9.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter4-hadoop2.html-Cv9_SDES.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-Drmjlpc8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/01.Hive-quickstart.html-xEt591iG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/02.Hive-ddl.html-oZcp1SJL.js" as="script"><link rel="prefetch" href="/simple-doc/assets/03.Hive-table.html-CNv8yYBJ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/04.Hive-index-view.html-CqLb37zC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/05.Hive-dml.html-7Uy6x2Jk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/06.Hive-multi-partition.html-B6eGiy2H.js" as="script"><link rel="prefetch" href="/simple-doc/assets/07.Hive-query.html-BwrwjZoi.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-CltMvCVn.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chapter5-hive.html-BEsAjTHI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/chaptere6-Hive简介及核心概念.html-D5yzNcFr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/hive-数据倾斜.html-CkSPaakF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/hadoop-install.html-Cg3Gc0pV.js" as="script"><link rel="prefetch" href="/simple-doc/assets/hive-install.html-Dz1E3_1M.js" as="script"><link rel="prefetch" href="/simple-doc/assets/01.rdd.html-ByX19H-x.js" as="script"><link rel="prefetch" href="/simple-doc/assets/01.rdd2.html-B9ucs_fO.js" as="script"><link rel="prefetch" href="/simple-doc/assets/02.dataframe.html-DXZjPIXr.js" as="script"><link rel="prefetch" href="/simple-doc/assets/03.dataset.html-RV0pL0Y7.js" as="script"><link rel="prefetch" href="/simple-doc/assets/06.graphx.html-BLB_isWG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/07.ml.html-bwTTSJ0y.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-EventTime.html-DFFxNZ_n.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-Implementation-and-Overview.html-5CB_VNqX.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-Sink.html-DYLDSxgN.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-Source.html-DDChVqdk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-Watermark.html-CpvQB7Zf.js" as="script"><link rel="prefetch" href="/simple-doc/assets/Structured-Streaming-stateStorage.html-PYppbO0O.js" as="script"><link rel="prefetch" href="/simple-doc/assets/broadcast.html-PV1qXZ1i.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-D5U7bFfP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-code-quick-start.html-Cvz18KMD.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-core.html-D_qK7XCT.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-core2.html-CxxZJ_6R.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-data-skew.html-BeECQwZw.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-executor.html-fWIVC2JA.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-introduce.html-CNPUv517.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-kafka.html-Bvqlayiz.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-sql.html-CFxS10Qs.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-streaming.html-C79K96h6.js" as="script"><link rel="prefetch" href="/simple-doc/assets/todo.html-BrW3RCq1.js" as="script"><link rel="prefetch" href="/simple-doc/assets/1-kafka延迟队列.html-BZ_r3pF8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/01-02-sql执行.html-ypyCqQwC.js" as="script"><link rel="prefetch" href="/simple-doc/assets/03-事务.html-DsUE2xMc.js" as="script"><link rel="prefetch" href="/simple-doc/assets/04-05-索引.html-b7w63ImY.js" as="script"><link rel="prefetch" href="/simple-doc/assets/06-07-锁.html-BR1EeZ2N.js" as="script"><link rel="prefetch" href="/simple-doc/assets/08-mvcc.html-Dd9DgzW4.js" as="script"><link rel="prefetch" href="/simple-doc/assets/09-普通索引和唯一索引.html-C3FV-VRB.js" as="script"><link rel="prefetch" href="/simple-doc/assets/10-12-DirtyPag脏页.html-Cbx_BzQF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/18-20-索引失效.html-By2t2Fbt.js" as="script"><link rel="prefetch" href="/simple-doc/assets/21-25-mysql高可用.html-nUDGlixI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/26-27-备库.html-PEK6bhmR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/28-读写分离有哪些坑.html-g0IlOWwu.js" as="script"><link rel="prefetch" href="/simple-doc/assets/29-33-数据库问题-查询多数内存不足.html-DWxpG-Mn.js" as="script"><link rel="prefetch" href="/simple-doc/assets/34 -到底可不可以使用join.html-pAMeKwyU.js" as="script"><link rel="prefetch" href="/simple-doc/assets/35-Join语句优化.html-Cgm-FzpJ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/36-39-临时表-自增主键.html-DcIzr4JI.js" as="script"><link rel="prefetch" href="/simple-doc/assets/40-insert语句的锁为什么这么多.html-B63BnMp0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/41-快速复制一张表.html-fXkCQd6A.js" as="script"><link rel="prefetch" href="/simple-doc/assets/42-grant之后要flush.html-CPTi5Mhd.js" as="script"><link rel="prefetch" href="/simple-doc/assets/43-分区表.html-BastDnVE.js" as="script"><link rel="prefetch" href="/simple-doc/assets/44-join问题.html-DCe6Kh5C.js" as="script"><link rel="prefetch" href="/simple-doc/assets/45-id-over.html-DJZ18FUF.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-slow-log.html-BOwGVcX7.js" as="script"><link rel="prefetch" href="/simple-doc/assets/mysql-删除大量数据.html-oCTGHFp0.js" as="script"><link rel="prefetch" href="/simple-doc/assets/SQLAdvisor.html-DTOR6C2j.js" as="script"><link rel="prefetch" href="/simple-doc/assets/soar.html-DysX_Ylq.js" as="script"><link rel="prefetch" href="/simple-doc/assets/env.html-DzQdQWtp.js" as="script"><link rel="prefetch" href="/simple-doc/assets/intro.html-CecazkeR.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-bUBlhSCM.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-CFwXfAJ3.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-docker-install.html-D9I2rBwk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-shell-install.html-BIlzyyeG.js" as="script"><link rel="prefetch" href="/simple-doc/assets/spark-standalone-install.html-CRCwPEgk.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-CjMzY8Dx.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BIlrSCLb.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-DDAHSmsP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-WrfS3nKJ.js" as="script"><link rel="prefetch" href="/simple-doc/assets/index.html-BLyo2htP.js" as="script"><link rel="prefetch" href="/simple-doc/assets/notice.html-BVj8t7x8.js" as="script"><link rel="prefetch" href="/simple-doc/assets/todo.html-BkJYktzm.js" as="script"><link rel="prefetch" href="/simple-doc/assets/404.html-CbAexRXt.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container no-sidebar external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/simple-doc/"><img class="vp-site-logo" src="/simple-doc/images/logo.png" alt="Blog"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">Blog</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/simple-doc/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/vue/" aria-label="Vue"><!--[--><!--[--><!--]--><!--]-->Vue<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/Typescript/" aria-label="TypeScript"><!--[--><!--[--><!--]--><!--]-->TypeScript<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/React/" aria-label="React"><!--[--><!--[--><!--]--><!--]-->React<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Angular"><!--[--><!--[--><!--]--><!--]-->Angular<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Node.js"><!--[--><!--[--><!--]--><!--]-->Node.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="小程序"><!--[--><!--[--><!--]--><!--]-->小程序<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Flutter"><!--[--><!--[--><!--]--><!--]-->Flutter<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据开发"><span class="title">数据开发</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据开发"><span class="title">数据开发</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/datawarehouse/" aria-label="数据产品"><!--[--><!--[--><!--]--><!--]-->数据产品<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><a class="route-link auto-link" href="/simple-doc/guide/etl/bigdata-readme.html" aria-label="大数据"><!--[--><!--[--><!--]--><!--]-->大数据<!--[--><!--[--><!--]--><!--]--></a></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/hadoop/" aria-label="Hadoop"><!--[--><!--[--><!--]--><!--]-->Hadoop<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/hive/" aria-label="Hive"><!--[--><!--[--><!--]--><!--]-->Hive<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/spark/" aria-label="Spark"><!--[--><!--[--><!--]--><!--]-->Spark<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/simple-doc/guide/mysql/" aria-label="MySQL"><!--[--><!--[--><!--]--><!--]-->MySQL<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Redis"><!--[--><!--[--><!--]--><!--]-->Redis<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="后端"><span class="title">后端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="后端"><span class="title">后端</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Python"><!--[--><!--[--><!--]--><!--]-->Python<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Golang"><!--[--><!--[--><!--]--><!--]-->Golang<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/GavinAlison2" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/simple-doc/" aria-label="首页"><!--[--><!--[--><!--]--><!--]-->首页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/vue/" aria-label="Vue"><!--[--><!--[--><!--]--><!--]-->Vue<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/Typescript/" aria-label="TypeScript"><!--[--><!--[--><!--]--><!--]-->TypeScript<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/React/" aria-label="React"><!--[--><!--[--><!--]--><!--]-->React<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Angular"><!--[--><!--[--><!--]--><!--]-->Angular<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Node.js"><!--[--><!--[--><!--]--><!--]-->Node.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="小程序"><!--[--><!--[--><!--]--><!--]-->小程序<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Flutter"><!--[--><!--[--><!--]--><!--]-->Flutter<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据开发"><span class="title">数据开发</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据开发"><span class="title">数据开发</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/guide/datawarehouse/" aria-label="数据产品"><!--[--><!--[--><!--]--><!--]-->数据产品<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><a class="route-link auto-link" href="/simple-doc/guide/etl/bigdata-readme.html" aria-label="大数据"><!--[--><!--[--><!--]--><!--]-->大数据<!--[--><!--[--><!--]--><!--]--></a></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/hadoop/" aria-label="Hadoop"><!--[--><!--[--><!--]--><!--]-->Hadoop<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/hive/" aria-label="Hive"><!--[--><!--[--><!--]--><!--]-->Hive<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/simple-doc/guide/etl/spark/" aria-label="Spark"><!--[--><!--[--><!--]--><!--]-->Spark<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/simple-doc/guide/mysql/" aria-label="MySQL"><!--[--><!--[--><!--]--><!--]-->MySQL<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Redis"><!--[--><!--[--><!--]--><!--]-->Redis<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="后端"><span class="title">后端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="后端"><span class="title">后端</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Java"><!--[--><!--[--><!--]--><!--]-->Java<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Python"><!--[--><!--[--><!--]--><!--]-->Python<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/simple-doc/pages/folder1/test1.html" aria-label="Golang"><!--[--><!--[--><!--]--><!--]-->Golang<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/GavinAlison2" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="_13-17" tabindex="-1"><a class="header-anchor" href="#_13-17"><span>13-17</span></a></h1><h2 id="_13-为什么表数据删掉一半-表文件大小不变" tabindex="-1"><a class="header-anchor" href="#_13-为什么表数据删掉一半-表文件大小不变"><span>13 | 为什么表数据删掉一半，表文件大小不变</span></a></h2><p>mysql8.0 之前，表结构以.frm为后缀的文件里。而8.0版本允许表结构定义放在系统数据表中，因为该部分占用空间很小。 参数 innodb_file_per_table</p><p>表数据既可以存在共享表空间里，也可以是单独的文件。</p><ul><li>OFF，表示表的数据放在系统共享表空间，也就是跟数据字典放在一起。drop table及时表删掉了，空间也不会回收。</li><li>ON（5.6.6版本后默认值），表示每个innodb表数据存储在以.ibd为后缀的文件中。drop table系统会直接删除这个文件。</li></ul><p>以下内容基于innodb_file_per_table on展开。</p><p>假设要删除R4，innodb只会标记R4删除。如果之后插入一个ID在300和600之间的记录时，可能会复用该位置。如果删掉整页，整个数据页可以被复用。所以磁盘文件大小不会缩小。</p><p>但记录复用，只能插入符合范围的数据。不能插入300~600范围外的数据。</p><p>页的复用，可以插入任何新数据。如pageA数据删除后，可以插入ID=50的数据。</p><p>如果相邻数据页利用率都很小，系统会把两个页的数据合到其中一个页上，另一个标记为可复用。</p><p>如果使用delete命令，那么所有数据页标记为可复用。</p><p>插入数据也会产生空洞，如果按索引递增插入，那么索引是紧凑的。如果数据插入随机，可能造成索引数据页分裂。</p><p>当某页满时，再插入数据，就会申请一个新页，将旧页的部分数据保存到新页中。所以旧页中可能有空洞。</p><p>更新索引，可能理解为删除旧值，插入新值。也会造成空洞。</p><h3 id="重建表" tabindex="-1"><a class="header-anchor" href="#重建表"><span>重建表</span></a></h3><p>重建表，可以新建一个表，将旧表中的数据一行一行读出来插入到新表中。然后以新表替换旧表。 可以使用 alter table A engine=InnoDB 命令来重建表。在mysql 5.5版本前，该命令流程与上述流程类似。 在此过程中，不能更新旧表数据。</p><p>MySQL 5.6 版本开始引入的 Online DDL，对该操作流程做了优化。</p><ul><li>建立一个临时文件，扫描表 A 主键的所有数据页；</li><li>用数据页中表 A 的记录生成 B+ 树，存储到临时文件中；</li><li>生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态；</li><li>临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件，对应的就是图中state3 的状态；</li><li>用临时文件替换表 A 的数据文件。</li></ul><p>重建方法都会扫描原表数据和构建临时文件。对于很大的表来说，这个操作是很消耗 IO 和 CPU 资源的。 如果是线上服务，要控制操作时间。如果想要比较安全的操作，推荐使用github开源的gh-ost。</p><p>optimize table、analyze table和 alter table 这三种方式重建表的区别。</p><ul><li>从 MySQL 5.6 版本开始，alter table t engine = InnoDB（也就是 recreate）默认是上图的流程；</li><li>analyze table t 其实不是重建表，只是对表的索引信息做重新统计，没有修改数据，这个过程中加了 MDL 读锁；</li><li>optimize table t 等于 recreate+analyze。</li></ul><h2 id="_14-count-这么慢-我该怎么办" tabindex="-1"><a class="header-anchor" href="#_14-count-这么慢-我该怎么办"><span>14 | count(*)这么慢，我该怎么办？</span></a></h2><h3 id="count-的实现方式" tabindex="-1"><a class="header-anchor" href="#count-的实现方式"><span>count(*) 的实现方式</span></a></h3><ul><li>MyISAM 引擎保存总行数，所以count很快。但如果加了where不能很快返回。</li><li>Innodb需要一行一行读出来累积计数。</li></ul><p>innodb由于多版本并发控制（MVCC）的原因，多个事务count的行数不同，所以不能保存总行数。 但count(*)做了优化，引擎会选择最小的普通索引树，来计数。而不是直接统计聚集索引树。</p><p>show table status 命令输出TABLE_ROWS 显示这个表当前有多少行，但它也是采样估算来的。官方文档说误差可能达到 40% 到 50%。</p><h3 id="用缓存系统保存计数" tabindex="-1"><a class="header-anchor" href="#用缓存系统保存计数"><span>用缓存系统保存计数</span></a></h3><p>两个问题：</p><ul><li>缓存会丢失</li><li>缓存不准确，因为缓存计数和插入数据不是原子操作，有可能在中间过程，其他事务读取了数据。</li></ul><h3 id="在数据库保存计数" tabindex="-1"><a class="header-anchor" href="#在数据库保存计数"><span>在数据库保存计数</span></a></h3><p>使用一张表保存计数，由于事务可以解决使用缓存问题。</p><p>不同的 count 用法</p><p>下面的讨论还是基于 InnoDB 引擎的</p><ul><li>count(主键 id) ，InnoDB 引擎会遍历整张表，把每一行的 id 值都取出来，返回给 server 层。server 层拿到 id 后，判断是不可能为空的，就按行累加。</li><li>count(1)，InnoDB 引擎遍历整张表，但不取值。server 层对于返回的每一行，放一个数字“1”进去，判断是不可能为空的，按行累加。</li><li>count(字段) a. 如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加； b. 如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加。</li><li>count()，并不会把全部字段取出来，而是专门做了优化，不取值。count() 肯定不是 null，按行累加。</li></ul><p>按照效率排序的话，<code>count(字段)&lt;count(主键 id)&lt;count(1)≈count()</code>，所以建议尽量使用 count()。</p><h2 id="_15-答疑文章-一-日志和索引相关问题" tabindex="-1"><a class="header-anchor" href="#_15-答疑文章-一-日志和索引相关问题"><span>15 | 答疑文章（一）：日志和索引相关问题</span></a></h2><h3 id="日志相关问题" tabindex="-1"><a class="header-anchor" href="#日志相关问题"><span>日志相关问题</span></a></h3><p>第2篇文章《日志系统：一条 SQL 更新语句是如何执行的？》，两阶段提交的不同瞬间MySQL 如果发生异常重启，是怎么保证数据完整性的？</p><p>redo log</p><p>如果redo处理perpare阶段，写binlog之前崩溃（crash），恢复时事务回滚。 如果binlog写完了，redo未commit前崩溃（crash）：</p><ul><li>如果redo log事务完整，有了commit标识，直接提交；</li><li>如果redo log里事务只有完整的perpare，则判断对应事务binlog是否完整： a. 如果是，则提交事务； b. 否则回滚。</li></ul><h3 id="追问-1-mysql-怎么知道-binlog-是完整的" tabindex="-1"><a class="header-anchor" href="#追问-1-mysql-怎么知道-binlog-是完整的"><span>追问 1：MySQL 怎么知道 binlog 是完整的?</span></a></h3><p>回答：一个事务的binlog是有完整格式的：</p><p>statement 格式的 binlog，最后会有 COMMIT； row 格式的 binlog，最后会有一个 XID event。</p><p>mysql 5.6.2版本以后，引入binlog-checksum验证binlog内容是否正确。</p><h3 id="追问-2-redo-log-和-binlog-是怎么关联起来的" tabindex="-1"><a class="header-anchor" href="#追问-2-redo-log-和-binlog-是怎么关联起来的"><span>追问 2：redo log 和 binlog 是怎么关联起来的？</span></a></h3><p>回答：它们有个共同的数据字段：XID。</p><h3 id="追问-3-处于-prepare-阶段的-redo-log-加上完整-binlog-重启就能恢复-mysql-为什么要这么设计" tabindex="-1"><a class="header-anchor" href="#追问-3-处于-prepare-阶段的-redo-log-加上完整-binlog-重启就能恢复-mysql-为什么要这么设计"><span>追问 3：处于 prepare 阶段的 redo log 加上完整 binlog，重启就能恢复，MySQL 为什么要这么设计?</span></a></h3><p>回答：因为写入binlog后，会被从库使用，为了保证主备一致性。</p><h3 id="追问-4-如果这样的话-为什么还要两阶段提交呢-干脆先-redo-log-写完-再写-binlog。崩溃恢复的时候-必须得两个日志都完整才可以。是不是一样的逻辑" tabindex="-1"><a class="header-anchor" href="#追问-4-如果这样的话-为什么还要两阶段提交呢-干脆先-redo-log-写完-再写-binlog。崩溃恢复的时候-必须得两个日志都完整才可以。是不是一样的逻辑"><span>追问 4：如果这样的话，为什么还要两阶段提交呢？干脆先 redo log 写完，再写 binlog。崩溃恢复的时候，必须得两个日志都完整才可以。是不是一样的逻辑？</span></a></h3><p>回答：两阶段提交是经典分布式系统问题，并不是mysql独有的。 innodb，如果redo log提交完成，事务就不能回滚（如果还允许回滚，可能覆盖掉别的事务的更新）。但如果redo log直接提交，binlog写失败时，innodb回滚不了 ，数据和binlog日志会不一致。两阶段提交就是为了每个“人”都ok，在一起提交。</p><h3 id="追问-5-不引入两个日志-也就没有两阶段提交的必要了。只用-binlog-来支持崩溃恢复-又能支持归档-不就可以了" tabindex="-1"><a class="header-anchor" href="#追问-5-不引入两个日志-也就没有两阶段提交的必要了。只用-binlog-来支持崩溃恢复-又能支持归档-不就可以了"><span>追问 5：不引入两个日志，也就没有两阶段提交的必要了。只用 binlog 来支持崩溃恢复，又能支持归档，不就可以了？</span></a></h3><p>回答：不可以，历史原因，innodb不是mysql原生引擎，binlog不支持崩溃恢复，所以innodb实现了redo log。</p><h3 id="追问-6-那能不能反过来-只用-redo-log-不要-binlog" tabindex="-1"><a class="header-anchor" href="#追问-6-那能不能反过来-只用-redo-log-不要-binlog"><span>追问 6：那能不能反过来，只用 redo log，不要 binlog</span></a></h3><p>回答：如果从崩溃恢复角度来讲是可以的。但redo log是循环写，历史日志没法保留，而binlog有归档功能。binlog还有可以实现复制主从同步。</p><h3 id="追问-7-redo-log-一般设置多大" tabindex="-1"><a class="header-anchor" href="#追问-7-redo-log-一般设置多大"><span>追问 7：redo log 一般设置多大？</span></a></h3><p>回答：redo log太小会导致很快写满，然后就会强行刷redo log。如果几个TB硬盘，直接将redo log设置为4个文件，每个文件1G。</p><h3 id="追问-8-正常运行中的实例-数据写入后的最终落盘-是从-redo-log-更新过来的还是从-buffer-pool-更新过来的呢" tabindex="-1"><a class="header-anchor" href="#追问-8-正常运行中的实例-数据写入后的最终落盘-是从-redo-log-更新过来的还是从-buffer-pool-更新过来的呢"><span>追问 8：正常运行中的实例，数据写入后的最终落盘，是从 redo log 更新过来的还是从 buffer pool 更新过来的呢？</span></a></h3><p>回答：这个问题就是“redo log 里面到底是什么”的问题。 redo log没有记录数据页完整数据，所以它没有能力自己去更新磁盘数据页。</p><p>如果再次运行的实例，数据页被修改，跟磁盘数据页不一致，称为脏页。最终数据落盘，就是把内存中的数据页写盘。这过程和redo log毫无关系。 在崩溃恢复场景，Innodb如果判断一个数据页可能在崩溃恢复时丢失更新，就会将它读到内存，然后让redo log更新内存内容。更新完成内存也变成脏页，就回到第一种情况。 ps：老师说这个问题很好，我之前学习的时候也想不明白刷盘流程，搜索了好久。</p><h3 id="追问-9-redo-log-buffer-是什么-是先修改内存-还是先写-redo-log-文件" tabindex="-1"><a class="header-anchor" href="#追问-9-redo-log-buffer-是什么-是先修改内存-还是先写-redo-log-文件"><span>追问 9：redo log buffer 是什么？是先修改内存，还是先写 redo log 文件？</span></a></h3><p>回答：在一个事务的更新过程中，日志是要写多次的。比如下面这个事务：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> t2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个事务往两个表中插记录过程中，生成的日志都要先保存起来，但不能在未commit的时候写到redo log里。 所以redo log buffer就是一块内存，用来先存redo日志。也就是说，在执行第一个 insert 的时候，数据的内存被修改了，redo log buffer 也写入了日志。 但是，真正写redo log文件（文件名是ib_logfile+数字），是在执行commit时做的。 单独执行一个更新语句，innodb会自己启动一个事务，过程和上述内容一致。</p><h2 id="_16-order-by-是怎么工作的" tabindex="-1"><a class="header-anchor" href="#_16-order-by-是怎么工作的"><span>16 | “order by”是怎么工作的</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>city<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>addr<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>city<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>city<span class="token punctuation">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"></span>
<span class="line"><span class="token number">1.</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;上海&#39;</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token number">2.</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;上海&#39;</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token number">3.</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;上海&#39;</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token number">4.</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;上海&#39;</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1000000000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token number">5.</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;上海&#39;</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">1000000000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">select</span> city<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age <span class="token keyword">from</span> t <span class="token keyword">where</span> city<span class="token operator">=</span><span class="token string">&#39;杭州&#39;</span> <span class="token keyword">order</span> <span class="token keyword">by</span> name <span class="token keyword">limit</span> <span class="token number">1000</span>  <span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> city<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age <span class="token keyword">from</span> t <span class="token keyword">where</span> city<span class="token operator">=</span><span class="token string">&#39;杭州&#39;</span> <span class="token keyword">order</span> <span class="token keyword">by</span> name <span class="token keyword">limit</span> <span class="token number">1000</span>  <span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">-</span> id<span class="token punctuation">,</span>select_type<span class="token punctuation">,</span><span class="token keyword">table</span><span class="token punctuation">,</span>partitions<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>possible_keys<span class="token punctuation">,</span><span class="token keyword">key</span><span class="token punctuation">,</span>key_len<span class="token punctuation">,</span>ref<span class="token punctuation">,</span><span class="token keyword">rows</span><span class="token punctuation">,</span>filtered<span class="token punctuation">,</span>Extra</span>
<span class="line"><span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">SIMPLE</span><span class="token punctuation">,</span>t<span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token keyword">ALL</span><span class="token punctuation">,</span>city<span class="token punctuation">,</span>city<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>const<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token keyword">Using</span> <span class="token keyword">Index</span> condition<span class="token punctuation">;</span><span class="token keyword">Using</span> filesort<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Extra中&quot;Using filesort&quot;表示排序，mysql会给每个线程分配一个块内存（sort_buffer）用来排序。</p><p>sql执行过程：</p><ol><li>初始化sort_buffer，确定放入name、city、age 这三个字段；</li><li>从city索引找到第一个city=&#39;杭州’的主键id，图中的ID_X；</li><li>根据id去聚集索引取这三个字段，放到sort_buffer；</li><li>在从city索引取下一个；</li><li>重复3、4查询所有的值；</li><li>在sort_buffer按name快速排序；</li><li>按照排序结果取前1000行返回给客户端。</li></ol><p>如果sort_buffer太小，内存放不下排序的数据，则需要使用外部排序，利用磁盘临时文件辅助排序。这取决于排序所需内存和参数 sort_buffer_size。</p><p>下面方法可以确定排序是否使用临时文件：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token comment">/* 打开 optimizer_trace，只对本线程有效 */</span></span>
<span class="line"><span class="token keyword">SET</span> optimizer_trace<span class="token operator">=</span><span class="token string">&#39;enabled=on&#39;</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token comment">/* @a 保存 Innodb_rows_read 的初始值 */</span></span>
<span class="line"><span class="token keyword">select</span> VARIABLE_VALUE <span class="token keyword">into</span> <span class="token variable">@a</span> <span class="token keyword">from</span>  performance_schema<span class="token punctuation">.</span>session_status <span class="token keyword">where</span> variable_name <span class="token operator">=</span> <span class="token string">&#39;Innodb_rows_read&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">/* 执行语句 */</span></span>
<span class="line"><span class="token keyword">select</span> city<span class="token punctuation">,</span> name<span class="token punctuation">,</span>age <span class="token keyword">from</span> t <span class="token keyword">where</span> city<span class="token operator">=</span><span class="token string">&#39;杭州&#39;</span> <span class="token keyword">order</span> <span class="token keyword">by</span> name <span class="token keyword">limit</span> <span class="token number">1000</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token comment">/* 查看 OPTIMIZER_TRACE 输出 */</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>information_schema<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>OPTIMIZER_TRACE<span class="token punctuation">`</span></span>\G</span>
<span class="line"><span class="token comment">/* @b 保存 Innodb_rows_read 的当前值 */</span></span>
<span class="line"><span class="token keyword">select</span> VARIABLE_VALUE <span class="token keyword">into</span> <span class="token variable">@b</span> <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>session_status <span class="token keyword">where</span> variable_name <span class="token operator">=</span> <span class="token string">&#39;Innodb_rows_read&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">/* 计算 Innodb_rows_read 差值 */</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token variable">@b</span><span class="token operator">-</span><span class="token variable">@a</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过查看 OPTIMIZER_TRACE，number_of_tmp_files表示排序使用的临时文件数，外部排序一般使用归并排序算法。 rows表示满足city=&#39;杭州’有4000条，examined_rows=4000表示4000行参与排序。 sort_mode packed_additional_fields表示排序过程字符串做了“紧凑”处理。name字段定义varchar(16)，排序过程中按照实际长度分配空间。 最后一个查询语句 select @b-@a返回结果是 4000，表示只扫描了4000行。</p><p>这边老师把internal_tmp_disk_storage_engine 设置成MyISAM，否则，select @b-@a结果为 4001。因为innodb把数据从临时表取出来时，会让Innodb_rows_read 的值加 1。</p><h3 id="rowid-排序" tabindex="-1"><a class="header-anchor" href="#rowid-排序"><span>rowid 排序</span></a></h3><p>如果排序的单行长度太大mysql会使用另一种算法。</p><p><code>SET max_length_for_sort_data = 16;</code></p><p>city、name、age 这三个字段的定义总长度是 36 &gt; max_length_for_sort_data，所以会使用别的算法。 该算法和全字段排序的差别：</p><ul><li>sort_buffer只会确定放入name 和 id字段，所以只会取这两个字段。</li><li>最后根据name排完序，会根据id字段去原表取city、name 和 age 三个字段返回给客户端。 需要注意，不做合并操作，而是直接将原表查到的字段返回给客户端。</li></ul><p>和上述过程对比：</p><p>examined_rows和rows没有变化，但select @b-@a会变成5000。因为排完序需要去原表再取1000行。</p><h3 id="全字段排序-vs-rowid-排序" tabindex="-1"><a class="header-anchor" href="#全字段排序-vs-rowid-排序"><span>全字段排序 VS rowid 排序</span></a></h3><p>对于 InnoDB 表来说，rowid 排序会要求回表多造成磁盘读，因此不会被优先选择。 假设从city索引上取出来的行天然按照name递增排序，就不需要再进行排序了。 所以可以建一个city和name的联合索引：</p><p><code>alter table t add index city_user(city, name);</code></p><p>整个查询流程就变成了：</p><ul><li>从索引(city, name)找到第一个city=&#39;杭州’的主键id；</li><li>到聚集索引取name、city、age三个字段，作为结果集一部分直接返回；</li><li>从索引(city, name)取下一个。</li><li>重复2、3，直到查到1000条记录，或不满足city=&#39;杭州’时结束。</li></ul><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> city<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age <span class="token keyword">from</span> t <span class="token keyword">where</span> city<span class="token operator">=</span><span class="token string">&#39;杭州&#39;</span> <span class="token keyword">order</span> <span class="token keyword">by</span> name <span class="token keyword">limit</span> <span class="token number">1000</span>  <span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">-</span> id<span class="token punctuation">,</span>select_type<span class="token punctuation">,</span><span class="token keyword">table</span><span class="token punctuation">,</span>partitions<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>possible_keys<span class="token punctuation">,</span><span class="token keyword">key</span><span class="token punctuation">,</span>key_len<span class="token punctuation">,</span>ref<span class="token punctuation">,</span><span class="token keyword">rows</span><span class="token punctuation">,</span>filtered<span class="token punctuation">,</span>Extra</span>
<span class="line"><span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">SIMPLE</span><span class="token punctuation">,</span>t<span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token keyword">ALL</span><span class="token punctuation">,</span>city_user<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>const<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token keyword">Using</span> <span class="token keyword">index</span> condition<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">没有<span class="token string">&quot;Using filesort&quot;</span>。</span>
<span class="line">使用覆盖索引：</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> city <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">&#39;杭州&#39;</span><span class="token punctuation">,</span><span class="token string">&quot; 苏州 &quot;</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> name <span class="token keyword">limit</span> <span class="token number">100</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>上述sql需要排序，因为name不是递增的。 可以将sql拆分成两条，最后通过程序内存取前100条。 进一步，如果需要分页，“limit 10000,100”，则可以使用下面的思想：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"></span>
<span class="line"><span class="token number">1.</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;上海&#39;</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">;</span>           <span class="token comment">// 取第10001-10100行</span></span>
<span class="line"><span class="token number">2.</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;上海&#39;</span> <span class="token operator">AND</span> age <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> age <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;上海&#39;</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// 取第10001-10100行</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>选取出 10100 数据， 在取出 10000 数据，然后求 10000 - 10100 的差值，作为 age 的上界，再取出 100 条数据。</p><p>问题一 ：这种无条件查列表页除了全表扫还有其他建立索引的办法么</p><p>1)无条件查询如果只有order by create_time,即便create_time上有索引,也不会使用到。 因为优化器认为走二级索引再去回表成本比全表扫描排序更高。 所以选择走全表扫描,然后根据老师讲的两种方式选择一种来排序 2)无条件查询但是是order by create_time limit m.如果m值较小,是可以走索引的. 因为优化器认为根据索引有序性去回表查数据,然后得到m条数据,就可以终止循环,那么成本比全表扫描小,则选择走二级索引。 即便没有二级索引,mysql针对order by limit也做了优化,采用堆排序。</p><p>问题二 : 如果加入 group by ， 数据该如何走</p><p>如果是group by a,a上不能使用索引的情况,是走rowid排序。 如果是group by limit,不能使用索引的情况,是走堆排序 如果是只有group by a,a上有索引的情况,又根据选取值不同,索引的扫描方式又有不同 select * from t group by a --走的是索引全扫描,至于这里为什么选择走索引全扫描 select a from t group by a --走的是索引松散扫描,也就说只需要扫描每组的第一行数据即可,不用扫描每一行的值</p><p>问题三 ：老师之后的文章会有讲解 bigInt(20) 、 tinyint(2) 、varchar(32) 这种后面带数字与不带数字有何区别的文章么 。 每次建字段都会考虑长度 ，但实际却不知道他有何作用</p><p>bigint和int加数字都不影响能存储的值。 bigint(1)和bigint(19)都能存储2^64-1范围内的值,int是 2^32-1。</p><p>只是有些前端会根据括号里来截取显示而已。建议不加varchar()就必须带,因为varchar()括号里的数字代表能存多少字符。</p><p>假设varchar(2),就只能存两个字符,不管是中文还是英文。目前来看varchar()这个值可以设得稍稍大点,因为内存是按照实际的大小来分配内存空间的,不是按照值来预分配的。</p><h2 id="_17-如何正确地显示随机消息" tabindex="-1"><a class="header-anchor" href="#_17-如何正确地显示随机消息"><span>17 | 如何正确地显示随机消息</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>words<span class="token punctuation">`</span></span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>word<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">delimiter</span> <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">create</span> <span class="token keyword">procedure</span> idata<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">begin</span></span>
<span class="line">  <span class="token keyword">declare</span> i <span class="token keyword">int</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">set</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">while</span> i<span class="token operator">&lt;</span><span class="token number">10000</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token keyword">insert</span> <span class="token keyword">into</span> words<span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token operator">+</span><span class="token punctuation">(</span>i <span class="token operator">div</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token operator">+</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">div</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token operator">+</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">div</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token operator">+</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">set</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">end</span><span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">delimiter</span> <span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">call</span> idata<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="内存临时表" tabindex="-1"><a class="header-anchor" href="#内存临时表"><span>内存临时表</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">select</span> word <span class="token keyword">from</span> words <span class="token keyword">order</span> <span class="token keyword">by</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">limit</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="磁盘临时表" tabindex="-1"><a class="header-anchor" href="#磁盘临时表"><span>磁盘临时表</span></a></h3><p>tmp_table_size限制了内存临时表的大小，默认16M。如果内存大于tmp_table_size，则会转成磁盘临时表。</p><p>磁盘临时表使用的引擎默认是 InnoDB，由参数 internal_tmp_disk_storage_engine 控制。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">temporary</span> <span class="token keyword">table</span> tmp_words <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> words <span class="token keyword">order</span> <span class="token keyword">by</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">limit</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tmp_words<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">set</span> tmp_table_size<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">set</span> sort_buffer_size<span class="token operator">=</span><span class="token number">32768</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">set</span> max_length_for_sort_data<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">/* 打开 optimizer_trace，只对本线程有效 */</span></span>
<span class="line"><span class="token keyword">SET</span> optimizer_trace<span class="token operator">=</span><span class="token string">&#39;enabled=on&#39;</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token comment">/* 执行语句 */</span></span>
<span class="line"><span class="token keyword">select</span> word <span class="token keyword">from</span> words <span class="token keyword">order</span> <span class="token keyword">by</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">limit</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">/* 查看 OPTIMIZER_TRACE 输出 */</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>information_schema<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>OPTIMIZER_TRACE<span class="token punctuation">`</span></span>\G</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新：: </span><time class="meta-item-info" datetime="2025-05-04T09:43:47.000Z" data-allow-mismatch>2025/5/4 09:43</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 921757697@qq.com">alice</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/simple-doc/assets/app-DzmgiGLk.js" defer></script>
  </body>
</html>
